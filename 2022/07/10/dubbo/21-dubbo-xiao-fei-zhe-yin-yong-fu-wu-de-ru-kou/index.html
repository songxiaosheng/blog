<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		
<title>21-ã€Dubbo3.0.8æºç è§£æç³»åˆ—ã€‘Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£ - ä¸­é—´ä»¶æºç </title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 6.2.0">
<link rel="stylesheet" href="/css/style.css?v=1664203059414">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1664203059414"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?2ee30baeebf59e698360da94012edd15';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="ä¸­é—´ä»¶æºç " type="application/atom+xml">
</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="ä¸­é—´ä»¶æºç ">ä¸­é—´ä»¶æºç </a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/index.html">é¦–é¡µ</a></li>
            
                <li class="nav-item"><a href="/categories">åˆ†ç±»</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>21-ã€Dubbo3.0.8æºç è§£æç³»åˆ—ã€‘Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£</h1>
			<div class="info"><span class="date">2022å¹´7æœˆ10æ—¥</span>â€¢songxiaosheng 
			
					ã€Š<a class="nexmoefont icon-appstore-fill -link" href="/categories/Dubbo3%E6%BA%90%E7%A0%81/">Dubbo3æºç </a>ã€‹
				
				<!-- 
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/dubbo/21-Dubboæ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡çš„å…¥å£.md" target="_blank" rel="external nofollow noreferrer noopener">ç¼–è¾‘</a>
				 -->
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="21-Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£"><a href="#21-Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£" class="headerlink" title="21-Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£"></a>21-Dubbo3æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡å…¥å£</h1><h2 id="21-1-ç®€ä»‹"><a href="#21-1-ç®€ä»‹" class="headerlink" title="21.1 ç®€ä»‹"></a>21.1 ç®€ä»‹</h2><p>å‰é¢æˆ‘ä»¬é€šè¿‡Demoè¯´äº†ä¸€ä¸ªæœåŠ¡å¼•ç”¨é…ç½®çš„åˆ›å»ºã€‚å¦å¤–ä¹Ÿåœ¨å‰é¢çš„æ–‡ç« è¯´äº†æœåŠ¡æä¾›è€…çš„å¯åŠ¨å®Œæ•´è¿‡ç¨‹ï¼Œä¸è¿‡åœ¨è¯´æœåŠ¡æä¾›è€…å¯åŠ¨çš„è¿‡ç¨‹ä¸­å¹¶æœªæåˆ°æœåŠ¡æ¶ˆè´¹è€…æ˜¯å¦‚ä½•å‘ç°æœåŠ¡ï¼Œå¦‚æœè°ƒç”¨æœåŠ¡çš„ï¼Œè¿™é‡Œå…ˆå°±ä¸å†è¯´å…³äºæœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨çš„ä¸€ä¸ªç»†èŠ‚äº†ï¼Œç›´æ¥æ¥çœ‹å‰é¢æœªæåˆ°çš„æœåŠ¡æ¶ˆè´¹è€…æ˜¯å¦‚ä½•å¼•ç”¨åˆ°æœåŠ¡æä¾›è€…æä¾›çš„æœåŠ¡çš„ã€‚<br>å…ˆæ¥å›é¡¾ä¸‹æ ·ä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runWithBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runWithBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DemoService</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reference<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">DemoService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reference<span class="token punctuation">.</span><span class="token function">setGeneric</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reference<span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DubboBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token class-name">DubboBootstrap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ApplicationConfig</span> applicationConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">"dubbo-demo-api-consumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        applicationConfig<span class="token punctuation">.</span><span class="token function">setQosEnable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        applicationConfig<span class="token punctuation">.</span><span class="token function">setQosPort</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span>applicationConfig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">"zookeeper://8.131.79.126:2181"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolConfig</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>DUBBO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">reference</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DemoService</span> demoService <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"dubbo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// generic invoke</span>
        <span class="token class-name">GenericService</span> genericService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GenericService</span><span class="token punctuation">)</span> demoService<span class="token punctuation">;</span>
        <span class="token class-name">Object</span> genericInvokeResult <span class="token operator">=</span> genericService<span class="token punctuation">.</span>$<span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">"sayHello"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"dubbo generic invoke"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>genericInvokeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ®µä»£ç æˆ‘ä»¬å‰é¢è¯¦ç»†è¯´äº†æœåŠ¡å¼•ç”¨çš„é…ç½®ReferenceConfigå’ŒDubboå¯åŠ¨å™¨å¯åŠ¨åº”ç”¨çš„è¿‡ç¨‹DubboBootstrapï¼Œåé¢æˆ‘ä»¬ç›´æ¥å®šä½åˆ°æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡çš„ä»£ç ä½ç½®æ¥çœ‹ã€‚</p>
<h2 id="21-2-å…¥å£ä»£ç "><a href="#21-2-å…¥å£ä»£ç " class="headerlink" title="21.2 å…¥å£ä»£ç "></a>21.2 å…¥å£ä»£ç </h2><h3 id="21-2-1-DefaultModuleDeployerçš„startæ–¹æ³•"><a href="#21-2-1-DefaultModuleDeployerçš„startæ–¹æ³•" class="headerlink" title="21.2.1 DefaultModuleDeployerçš„startæ–¹æ³•"></a>21.2.1 DefaultModuleDeployerçš„startæ–¹æ³•</h3><p>ç¬¬ä¸€ä¸ªè¦å…³æ³¨çš„å°±æ˜¯æ¨¡å—å‘å¸ƒå™¨DefaultModuleDeployerçš„startæ–¹æ³•ï¼Œè¿™ä¸ªstartæ–¹æ³•åŒ…å«äº†Dubboåº”ç”¨å¯åŠ¨çš„è¿‡ç¨‹</p>
<p>DefaultModuleDeployerçš„startæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Future</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥æ‰è‹¥å¹²ä»£ç 

            <span class="token function">onModuleStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// initialize</span>
            applicationDeployer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// export services</span>
            <span class="token function">exportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// prepare application instance</span>
            <span class="token comment">// exclude internal module to avoid wait itself</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleModel <span class="token operator">!=</span> moduleModel<span class="token punctuation">.</span><span class="token function">getApplicationModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInternalModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                applicationDeployer<span class="token punctuation">.</span><span class="token function">prepareInternalModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// refer services</span>
            <span class="token function">referServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥æ‰è‹¥å¹²ä»£ç 
        <span class="token keyword">return</span> startFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªæ–¹æ³•å¤§éƒ¨åˆ†ä»£ç å·²ç»çœç•¥ï¼Œä¹Ÿä¸ä¼šè¯¦ç»†å»è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¹‹å‰è®²åˆ°çš„åšå®¢ï¼Œè¿™é‡Œä¸»è¦æ¥çœ‹å¼•ç”¨æœåŠ¡æ–¹æ³•referServices</p>
<h3 id="21-2-2-DefaultModuleDeployerçš„referServicesæ–¹æ³•"><a href="#21-2-2-DefaultModuleDeployerçš„referServicesæ–¹æ³•" class="headerlink" title="21.2.2 DefaultModuleDeployerçš„referServicesæ–¹æ³•"></a>21.2.2 DefaultModuleDeployerçš„referServicesæ–¹æ³•</h3><p>ä¸‹é¢å°±è¦æ¥çœ‹æ¶ˆè´¹è€…åº”ç”¨å¦‚ä½•å¼•ç”¨çš„æœåŠ¡çš„å…¥å£äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ä»å¤§çš„æ–¹é¢åšäº†ä¸€äº›æœåŠ¡å¼•ç”¨ç”Ÿå‘½å‘¨æœŸçš„ä»£ç ï¼Œçœ‹æ‡‚äº†è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥ä¸ä¾èµ–Dubboè´Ÿè½½çš„å¯åŠ¨é€»è¾‘å¯ä»¥å•ç‹¬è°ƒç”¨ReferenceConfigBaseç±»å‹çš„å¯¹åº”æ–¹æ³•æ¥åˆ·æ–°ï¼Œå¯åŠ¨ï¼Œé”€æ¯å¼•ç”¨çš„æœåŠ¡äº†è¿™é‡Œå…ˆæ¥çœ‹ä¸‹ä»£ç å†è¯¦ç»†ä»‹ç»å†…å®¹ï¼š</p>
<p>DefaultModuleDeployerçš„referServicesæ–¹æ³• </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">referServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//è¿™ä¸ªæ˜¯è·å–é…ç½®çš„æ‰€æœ‰çš„ReferenceConfigBaseç±»å‹å¯¹è±¡</span>
    configManager<span class="token punctuation">.</span><span class="token function">getReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rc <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>referenceConfig<span class="token punctuation">.</span><span class="token function">isRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//åˆ·æ–°å¼•ç”¨é…ç½®</span>
                referenceConfig<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">.</span><span class="token function">shouldInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>referAsync <span class="token operator">||</span> rc<span class="token punctuation">.</span><span class="token function">shouldReferAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> executorRepository<span class="token punctuation">.</span><span class="token function">getServiceReferExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//é—´æ¥çš„é€šè¿‡ç¼“å­˜å¯¹è±¡æ¥å¼•ç”¨æœåŠ¡é…ç½®</span>
                            referenceCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" refer async catch error : "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    asyncReferringFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//é—´æ¥çš„é€šè¿‡ç¼“å­˜å¯¹è±¡æ¥å¼•ç”¨æœåŠ¡é…ç½®</span>
                    referenceCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" refer catch error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å‡ºç°å¼‚å¸¸é”€æ¯å¼•ç”¨é…ç½®</span>
            referenceCache<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™ä¸ªä»£ç ä¸­æˆ‘ä»¬æ ¸å¿ƒéœ€è¦å…³å¿ƒçš„å°±æ˜¯SimpleReferenceCacheç±»å‹çš„getæ–¹æ³•äº†ï¼Œåœ¨è·å–æœåŠ¡å¯¹è±¡ä¹‹å¤–åŒ…è£…äº†ä¸€å±‚ç¼“å­˜ã€‚</p>
<p>å¦‚æœå‡ºç°äº†å¼‚å¸¸åˆ™æ‰§è¡ŒreferenceCacheçš„destroyæ–¹æ³•è¿›è¡Œé”€æ¯å¼•ç”¨é…ç½®ã€‚</p>
<h2 id="21-3-å¼€å§‹å¼•ç”¨æœåŠ¡"><a href="#21-3-å¼€å§‹å¼•ç”¨æœåŠ¡" class="headerlink" title="21.3 å¼€å§‹å¼•ç”¨æœåŠ¡"></a>21.3 å¼€å§‹å¼•ç”¨æœåŠ¡</h2><h3 id="21-3-1-SimpleReferenceCacheæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#21-3-1-SimpleReferenceCacheæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="21.3.1 SimpleReferenceCacheæ˜¯ä»€ä¹ˆï¼Ÿ"></a>21.3.1 SimpleReferenceCacheæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ä¸€ä¸ªç”¨äºç¼“å­˜å¼•ç”¨ReferenceConfigBaseçš„utilå·¥å…·ç±»ã€‚<br>ReferenceConfigBaseæ˜¯ä¸€ä¸ªé‡å¯¹è±¡ï¼Œå¯¹äºé¢‘ç¹åˆ›å»ºReferenceConfigBaseçš„æ¡†æ¶æ¥è¯´ï¼Œæœ‰å¿…è¦ç¼“å­˜è¿™äº›å¯¹è±¡ã€‚<br>å¦‚æœéœ€è¦ä½¿ç”¨å¤æ‚çš„ç­–ç•¥ï¼Œå¯ä»¥å®ç°å¹¶ä½¿ç”¨è‡ªå·±çš„ReferenceConfigBaseç¼“å­˜<br>è¿™ä¸ªCacheæ˜¯å¼•ç”¨æœåŠ¡çš„å¼€å§‹å¦‚æœæˆ‘ä»¬æƒ³åœ¨ä»£ç ä¸­è‡ªå®šä¹‰ä¸€äº›æœåŠ¡å¼•ç”¨çš„é€»è¾‘ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºSimpleReferenceCacheç±»å‹å¯¹è±¡ç„¶åè°ƒç”¨å…¶getæ–¹æ³•è¿›è¡Œå¼•ç”¨æœåŠ¡ã€‚é‚£è¿™ä¸ªç¼“å­˜å¯¹è±¡æ˜¯å’Œç¼“å­˜ä¸å¼•ç”¨æœåŠ¡çš„å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<h3 id="21-3-2-å¼•ç”¨æœåŠ¡ä¹‹å‰çš„ç¼“å­˜å¤„ç†é€»è¾‘ï¼Ÿ"><a href="#21-3-2-å¼•ç”¨æœåŠ¡ä¹‹å‰çš„ç¼“å­˜å¤„ç†é€»è¾‘ï¼Ÿ" class="headerlink" title="21.3.2 å¼•ç”¨æœåŠ¡ä¹‹å‰çš„ç¼“å­˜å¤„ç†é€»è¾‘ï¼Ÿ"></a>21.3.2 å¼•ç”¨æœåŠ¡ä¹‹å‰çš„ç¼“å­˜å¤„ç†é€»è¾‘ï¼Ÿ</h3><p>å…³äºé€»è¾‘çš„å¤„ç†ï¼Œçœ‹ä»£ç æœ‰æ—¶å€™æ¯”æ–‡å­—æ›´æ¸…æ™°æ˜äº†ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥æ¥çœ‹ SimpleReferenceCacheç±»å‹çš„getæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ReferenceConfigBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è¿™ä¸ªç”Ÿæˆçš„keyè§„åˆ™æ˜¯è¿™æ ·çš„ æœåŠ¡åˆ†ç»„/æœåŠ¡æ¥å£:ç‰ˆæœ¬å·  è¯¦ç»†çš„ä»£ç å°±ä¸çœ‹äº†</span>
        <span class="token comment">//ä¾‹å¦‚ï¼š group/link.elastic.dubbo.entity.DemoService:1.0</span>
       <span class="token class-name">String</span> key <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//æœåŠ¡ç±»å‹ å¦‚æœæ˜¯æ³›åŒ–è°ƒç”¨åˆ™è¿™ä¸ªç±»å‹ä¸ºGenericService</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> rc<span class="token punctuation">.</span><span class="token function">getInterfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//æœåŠ¡æ˜¯å¦ä¸ºå•ä¾‹çš„è¿™é‡Œé»˜è®¤å€¼éƒ½ä¸ºç©ºï¼Œä¸ºå•ä¾‹æ¨¡å¼</span>
       <span class="token keyword">boolean</span> singleton <span class="token operator">=</span> rc<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rc<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">T</span> proxy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">// Check existing proxy of the same 'key' and 'type' first.</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//ä¸€èˆ¬ä¸ºå•ä¾‹çš„ è¿™ä¸ªæ–¹æ³•æ˜¯ä»ç¼“å­˜ä¸­è·å–</span>
           proxy <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment">//éå•ä¾‹å®¹æ˜“é€ æˆå†…å­˜æ³„éœ²ï¼Œæ— æ³•ä»ç¼“å­˜ä¸­è·å–</span>
           logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Using non-singleton ReferenceConfig and ReferenceCache at the same time may cause memory leak. "</span> <span class="token operator">+</span>
               <span class="token string">"Call ReferenceConfig#get() directly for non-singleton ReferenceConfig instead of using ReferenceCache#get(ReferenceConfig)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//å‰é¢æ˜¯ä»ç¼“å­˜ä¸­æ‹¿ï¼Œå¦‚æœç¼“å­˜ä¸­è·å–ä¸åˆ°åˆ™å¼€å§‹å¼•ç”¨æœåŠ¡</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//è·å–æˆ–è€…åˆ›å»ºå€¼ï¼Œä¸ºå¼•ç”¨ç±»å‹referencesOfTypeå¯¹è±¡ï¼ˆç±»å‹ä¸ºMap&lt;Class&lt;?&gt;, List&lt;ReferenceConfigBase&lt;?&gt;&gt;&gt;ï¼‰ç¼“å­˜å¯¹è±¡ç”Ÿæˆå€¼ï¼ˆå€¼ä¸å­˜å’‹æ—¶å€™ä¼šç”Ÿæˆä¸€ä¸ªï¼‰</span>
           <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceConfigBase</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> referencesOfType <span class="token operator">=</span> referenceTypeMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> _t <span class="token operator">-&gt;</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//æ¯æ¬¡èµ°åˆ°è¿™é‡Œéƒ½ä¼šæ·»åŠ ä¸€ä¸ªReferenceConfigBase å¼•ç”¨é…ç½®å¯¹è±¡ï¼ˆå•ä¾‹çš„ä»ç¼“å­˜ä¸­æ‹¿åˆ°å°±å¯ä»¥ç›´æ¥è¿”å›äº†ï¼‰</span>
           referencesOfType<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">//ä¸å‰é¢ä¸€æ · å‰é¢æ˜¯ç±»å‹æ˜ å°„ï¼Œè¿™é‡Œæ˜¯keyæ˜ å°„</span>
           <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceConfigBase</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> referenceConfigList <span class="token operator">=</span> referenceKeyMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> _k <span class="token operator">-&gt;</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           referenceConfigList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//å¼€å§‹å¼•ç”¨æœåŠ¡</span>
           proxy <span class="token operator">=</span> rc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªé€»è¾‘ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼ï¼ˆå…¶å®å°±æ˜¯å…ˆæŸ¥ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨åˆ™åˆ›å»ºå¯¹è±¡å­˜å…¥ç¼“å­˜ï¼‰æ¥è¿›è¡Œå¼•ç”¨å¯¹è±¡çš„ç®¡ç†è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™é‡Œä¸€å…±æœ‰ä¸¤ä¸ªç¼“å­˜å¯¹è±¡referencesOfTypeå’ŒreferenceConfigList<br>keyåˆ†åˆ«ä¸ºå¼•ç”¨ç±»å‹å’Œå¼•ç”¨çš„æœåŠ¡çš„keyï¼Œå€¼æ˜¯å¼•ç”¨æœåŠ¡çš„åŸºç¡€é…ç½®å¯¹è±¡åˆ—è¡¨List&lt;ReferenceConfigBase&lt;?&gt;&gt;</p>
<p>åé¢å¯ä»¥è¯¦ç»†çœ‹ä¸‹å¦‚æœå€ŸåŠ©ReferenceConfigBaseç±»å‹å¯¹è±¡æ¥è¿›è¡Œå…·ä½“ç±»å‹çš„å¼•ç”¨ã€‚</p>
<h2 id="21-4-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è¿‡ç¨‹"><a href="#21-4-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è¿‡ç¨‹" class="headerlink" title="21.4 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è¿‡ç¨‹"></a>21.4 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è¿‡ç¨‹</h2><h3 id="21-4-1-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è°ƒç”¨å…¥å£"><a href="#21-4-1-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è°ƒç”¨å…¥å£" class="headerlink" title="21.4.1 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è°ƒç”¨å…¥å£"></a>21.4.1 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡çš„è°ƒç”¨å…¥å£</h3><p>å¼•ç”¨æœåŠ¡çš„é€»è¾‘å…¶å®æ˜¯ç›¸å¯¹å¤æ‚ä¸€ç‚¹çš„ï¼ŒåŒ…å«äº†æœåŠ¡å‘ç°ï¼Œå¼•ç”¨å¯¹è±¡çš„åˆ›å»ºç­‰ç­‰ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹:</p>
<p>ReferenceConfigç±»å‹çš„getæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The invoker of ReferenceConfig("</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">") has already destroyed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//refç±»å‹ä¸º transient volatile T ref;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ensure start module, compatible with old api usage</span>
            <span class="token comment">//è¿™ä¸ªå‰é¢å·²ç»è°ƒç”¨äº†æ¨¡å—å‘å¸ƒå™¨å¯åŠ¨è¿‡äº†ï¼Œè¿™é‡Œæœ‰è¿™ä¹ˆä¸€è¡Œä»£ç æ˜¯æœ‰ä¸€å®šä½œç”¨çš„ï¼Œå¦‚æœä½¿ç”¨æ–¹ç›´æ¥è°ƒç”¨äº†ReferenceConfigBaseçš„getæ–¹æ³•æˆ–è€…ç¼“å­˜å¯¹è±¡SimpleReferenceCacheç±»å‹çš„å¯¹è±¡çš„getæ–¹æ³•æ¥å¼•ç”¨æœåŠ¡ç«¯çš„æ—¶å€™å°±ä¼šé€ æˆå¾ˆå¤šé…ç½®æ²¡æœ‰åˆå§‹åŒ–ä¸‹é¢æ‰§è¡Œé€»è¾‘çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Œè¿™ä¸ªä»£ç å…¶å®å°±æ˜¯å¯åŠ¨æ¨¡å—è¿›è¡Œä¸€äº›åŸºç¡€é…ç½®çš„åˆå§‹åŒ–æ“ä½œ æ¯”å¦‚å…ƒæ•°æ®ä¸­å¿ƒé»˜è®¤é…ç½®é€‰æ‹©ï¼Œæ³¨å†Œä¸­å¿ƒé»˜è®¤é…ç½®é€‰æ‹©è¿™äº›éƒ½æ˜¯æ¯”è¾ƒé‡è¦çš„</span>
            <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeployer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ref<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œæœ‰ä¸€æ®µä»£ç æ˜¯ï¼šgetScopeModel().getDeployer().start();<br>è¿™ä¸ªå‰é¢å·²ç»è°ƒç”¨äº†æ¨¡å—å‘å¸ƒå™¨å¯åŠ¨è¿‡äº†ï¼Œè¿™é‡Œæœ‰è¿™ä¹ˆä¸€è¡Œä»£ç æ˜¯æœ‰ä¸€å®šä½œç”¨çš„ï¼Œå¦‚æœä½¿ç”¨æ–¹ç›´æ¥è°ƒç”¨äº†ReferenceConfigBaseçš„getæ–¹æ³•æˆ–è€…ç¼“å­˜å¯¹è±¡SimpleReferenceCacheç±»å‹çš„å¯¹è±¡çš„getæ–¹æ³•æ¥å¼•ç”¨æœåŠ¡ç«¯çš„æ—¶å€™å°±ä¼šé€ æˆå¾ˆå¤šé…ç½®æ²¡æœ‰åˆå§‹åŒ–ä¸‹é¢æ‰§è¡Œé€»è¾‘çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Œè¿™ä¸ªä»£ç å…¶å®å°±æ˜¯å¯åŠ¨æ¨¡å—è¿›è¡Œä¸€äº›åŸºç¡€é…ç½®çš„åˆå§‹åŒ–æ“ä½œ æ¯”å¦‚å…ƒæ•°æ®ä¸­å¿ƒé»˜è®¤é…ç½®é€‰æ‹©ï¼Œæ³¨å†Œä¸­å¿ƒé»˜è®¤é…ç½®é€‰æ‹©è¿™äº›éƒ½æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚</p>
<p>å¦å¤–å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œä½¿ç”¨äº†åŒé‡æ ¡éªŒé”æ¥ä¿è¯å•ä¾‹å¯¹è±¡çš„åˆ›å»ºï¼Œå‘ç°Dubboç§å¤§é‡çš„ä½¿ç”¨äº†åŒé‡æ ¡éªŒé”çš„é€»è¾‘ã€‚</p>
<h3 id="21-4-2-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡"><a href="#21-4-2-åˆå§‹åŒ–å¼•ç”¨æœåŠ¡" class="headerlink" title="21.4.2 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡"></a>21.4.2 åˆå§‹åŒ–å¼•ç”¨æœåŠ¡</h3><p>è¿™ä¸ªå°±ç›´æ¥çœ‹ä»£ç äº†è¿™ï¼Œåˆå§‹åŒ–è¿‡ç¨‹ç›¸å¯¹å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹<br>ReferenceConfigç±»å‹init()æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//åˆå§‹åŒ–æ ‡è®°å˜é‡ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œè¿™é‡Œåˆæ˜¯åŠ é”ğŸ”åˆæ˜¯åŠ æ ‡è®°å˜é‡çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ·æ–°é…ç½®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// init serviceMetadata</span>
        <span class="token comment">//åˆå§‹åŒ–ServiceMetadataç±»å‹å¯¹è±¡serviceMetadata ä¸ºå…¶è®¾ç½®æœåŠ¡åŸºæœ¬å±æ€§æ¯”å¦‚ç‰ˆæœ¬å·ï¼Œåˆ†ç»„ï¼ŒæœåŠ¡æ¥å£å</span>
        <span class="token function">initServiceMetadata</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//ç»§ç»­åˆå§‹åŒ–å…ƒæ•°æ®ä¿¡æ¯ æœåŠ¡æ¥å£ç±»å‹å’Œkey</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">setServiceType</span><span class="token punctuation">(</span><span class="token function">getServiceInterfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO, uncomment this line once service key is unified</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">setServiceKey</span><span class="token punctuation">(</span>URL<span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//é…ç½®è½¬Mapç±»å‹</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> referenceParameters <span class="token operator">=</span> <span class="token function">appendConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// init service-application mapping</span>
        <span class="token comment">//æ¥è‡ªæœ¬åœ°å­˜å‚¨å’Œurlå‚æ•°çš„åˆå§‹åŒ–æ˜ å°„ã€‚ å‚æ•°è½¬URLé…ç½®åˆå§‹åŒ– Dubboä¸­å–œæ¬¢ç”¨urlä½œä¸ºé…ç½®çš„ä¸€ç§å¤„ç†æ–¹å¼</span>
        <span class="token function">initServiceAppsMapping</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//æœ¬åœ°å†…å­˜æ¨¡å—æœåŠ¡å­˜å‚¨åº“</span>
        <span class="token class-name">ModuleServiceRepository</span> repository <span class="token operator">=</span> <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ServiceModelå’ŒServiceMetadataåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯ç›¸äº’é‡å¤çš„ã€‚æˆ‘ä»¬å°†æ¥åº”è¯¥åˆå¹¶å®ƒä»¬ã€‚</span>
        <span class="token class-name">ServiceDescriptor</span> serviceDescriptor<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>NATIVE_STUB<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serviceDescriptor <span class="token operator">=</span> <span class="token class-name">StubSuppliers</span><span class="token punctuation">.</span><span class="token function">getServiceDescriptor</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            repository<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//æœ¬åœ°å­˜å‚¨åº“æ³¨å†ŒæœåŠ¡æ¥å£ç±»å‹</span>
            serviceDescriptor <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æ¶ˆè´¹è€…æ¨¡å‹å¯¹è±¡</span>
        consumerModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerModel</span><span class="token punctuation">(</span>serviceMetadata<span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> serviceDescriptor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
            <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceMetadata<span class="token punctuation">,</span> <span class="token function">createAsyncMethodInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//æœ¬åœ°å­˜å‚¨åº“æ³¨å†Œæ¶ˆè´¹è€…æ¨¡å‹å¯¹è±¡</span>
        repository<span class="token punctuation">.</span><span class="token function">registerConsumer</span><span class="token punctuation">(</span>consumerModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ä¸å‰é¢ä»£ç ä¸€æ ·åŸºç¡€åˆå§‹åŒ–æœåŠ¡å…ƒæ•°æ®å¯¹è±¡ä¸ºå…¶è®¾ç½®é™„åŠ å‚æ•°</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºæœåŠ¡çš„ä»£ç†å¯¹è±¡ ï¼ï¼ï¼æ ¸å¿ƒä»£ç åœ¨è¿™é‡Œ</span>
        ref <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ä¸ºæœåŠ¡å…ƒæ•°æ®å¯¹è±¡è®¾ç½®ä»£ç†å¯¹è±¡</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span>PROXY_CLASS_REF<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumerModel<span class="token punctuation">.</span><span class="token function">setProxyObject</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerModel<span class="token punctuation">.</span><span class="token function">initMethodModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//æ£€æŸ¥invokerå¯¹è±¡åˆå§‹ç»“æœ</span>
        <span class="token function">checkInvokerAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="21-5-ReferenceConfigåˆ›å»ºæœåŠ¡å¼•ç”¨ä»£ç†å¯¹è±¡çš„åŸç†"><a href="#21-5-ReferenceConfigåˆ›å»ºæœåŠ¡å¼•ç”¨ä»£ç†å¯¹è±¡çš„åŸç†" class="headerlink" title="21.5 ReferenceConfigåˆ›å»ºæœåŠ¡å¼•ç”¨ä»£ç†å¯¹è±¡çš„åŸç†"></a>21.5 ReferenceConfigåˆ›å»ºæœåŠ¡å¼•ç”¨ä»£ç†å¯¹è±¡çš„åŸç†</h2><h3 id="21-5-1-ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹"><a href="#21-5-1-ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="21.5.1 ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹"></a>21.5.1 ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹</h3><p>è¿™é‡Œå°±è¦ç»§ç»­çœ‹ ReferenceConfigç±»å‹çš„åˆ›å»ºä»£ç†æ–¹æ³•createProxyäº†<br>ç›´æ¥è´´ä¸€ä¸‹æºç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> referenceParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æœ¬åœ°å¼•ç”¨ è¿™é‡Œä¸ºfalse</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldJvmRefer</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">createInvokerForLocal</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           urls<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//urlå­˜åœ¨åˆ™ä¸ºç‚¹å¯¹ç‚¹å¼•ç”¨</span>
               <span class="token comment">// user specified URL, could be peer-to-peer address, or register center's address.</span>
               <span class="token function">parseUrl</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// if protocols not in jvm checkRegistry</span>
               <span class="token comment">//è¿™é‡Œä¸æ˜¯localåè®®é»˜è®¤è¿™é‡Œä¸ºç©º</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LOCAL_PROTOCOL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token comment">//ä»æ³¨å†Œè¡¨ä¸­è·å–URLå¹¶å°†å…¶èšåˆã€‚è¿™ä¸ªå…¶å®å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸‹æ³¨å†Œä¸­å¿ƒçš„urlé…ç½®</span>
                   <span class="token function">aggregateUrlFromRegistry</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//è¿™ä¸ªä»£ç éå¸¸é‡è¦ åˆ›å»ºè¿œç¨‹å¼•ç”¨ï¼Œåˆ›å»ºè¿œç¨‹å¼•ç”¨è°ƒç”¨å™¨</span>
           <span class="token function">createInvokerForRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Referred dubbo service: ["</span> <span class="token operator">+</span> referenceParameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>INTERFACE_KEY<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]."</span> <span class="token operator">+</span>
               <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>referenceParameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>GENERIC_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                   <span class="token string">" it's GenericService reference"</span> <span class="token operator">:</span> <span class="token string">" it's not GenericService reference"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token class-name">URL</span> consumerUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfigURL</span><span class="token punctuation">(</span>CONSUMER_PROTOCOL<span class="token punctuation">,</span> referenceParameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>REGISTER_IP_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
           referenceParameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>INTERFACE_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span> referenceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumerUrl <span class="token operator">=</span> consumerUrl<span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumerUrl <span class="token operator">=</span> consumerUrl<span class="token punctuation">.</span><span class="token function">setServiceModel</span><span class="token punctuation">(</span>consumerModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">MetadataUtils</span><span class="token punctuation">.</span><span class="token function">publishServiceDefinition</span><span class="token punctuation">(</span>consumerUrl<span class="token punctuation">,</span> consumerModel<span class="token punctuation">.</span><span class="token function">getServiceModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getApplicationModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// create service proxy</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isGeneric</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="21-5-2-åˆ›å»ºè¿œç¨‹å¼•ç”¨ï¼Œåˆ›å»ºè¿œç¨‹å¼•ç”¨è°ƒç”¨å™¨"><a href="#21-5-2-åˆ›å»ºè¿œç¨‹å¼•ç”¨ï¼Œåˆ›å»ºè¿œç¨‹å¼•ç”¨è°ƒç”¨å™¨" class="headerlink" title="21.5.2 åˆ›å»ºè¿œç¨‹å¼•ç”¨ï¼Œåˆ›å»ºè¿œç¨‹å¼•ç”¨è°ƒç”¨å™¨"></a>21.5.2 åˆ›å»ºè¿œç¨‹å¼•ç”¨ï¼Œåˆ›å»ºè¿œç¨‹å¼•ç”¨è°ƒç”¨å™¨</h3><p>ReferenceConfigç±»å‹çš„createInvokerForRemoteæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createInvokerForRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//è¿™ä¸ªurl ä¸ºæ³¨å†Œåè®®å¦‚registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-consumer&amp;dubbo=2.0.2&amp;pid=6204&amp;qos.enable=false&amp;qos.port=-1&amp;registry=zookeeper&amp;release=3.0.9&amp;timestamp=1657439419495</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">URL</span> curUrl <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è¿™ä¸ªSPIå¯¹è±¡æ˜¯ç”±å­—èŠ‚ç åŠ¨æ€ç”Ÿæˆçš„è‡ªé€‚åº”å¯¹è±¡Protocol$Adaptieç›´æ¥çœ‹çœ‹ä¸åˆ°æºç ï¼Œåç»­å¯ä»¥è§£æä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆçš„ç±»å‹ï¼Œè¿™é‡Œåç»­æ¥è°ƒç”¨é“¾è·¯å³å¯</span>
            invoker <span class="token operator">=</span> protocolSPI<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> curUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>curUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                invoker <span class="token operator">=</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">,</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>curUrl<span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">URL</span> registryUrl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>URL url <span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// For multi-registry scenarios, it is not checked whether each referInvoker is available.</span>
                <span class="token comment">// Because this invoker may become available later.</span>
                invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>protocolSPI<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// use last registry url</span>
                    registryUrl <span class="token operator">=</span> url<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>registryUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// registry url is available</span>
                <span class="token comment">// for multi-subscription scenario, use 'zone-aware' policy by default</span>
                <span class="token class-name">String</span> cluster <span class="token operator">=</span> registryUrl<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>CLUSTER_KEY<span class="token punctuation">,</span> <span class="token class-name">ZoneAwareCluster</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// The invoker wrap sequence would be: ZoneAwareClusterInvoker(StaticDirectory) -&gt; FailoverClusterInvoker</span>
                <span class="token comment">// (RegistryDirectory, routing happens here) -&gt; Invoker</span>
                invoker <span class="token operator">=</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span>registryUrl<span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>registryUrl<span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// not a registry url, must be direct invoke.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>invokers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"invokers == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">URL</span> curUrl <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> cluster <span class="token operator">=</span> curUrl<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>CLUSTER_KEY<span class="token punctuation">,</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                invoker <span class="token operator">=</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>curUrl<span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="21-5-3-Invokerå¯¹è±¡åˆ›å»ºçš„å…¨è¿‡ç¨‹"><a href="#21-5-3-Invokerå¯¹è±¡åˆ›å»ºçš„å…¨è¿‡ç¨‹" class="headerlink" title="21.5.3 Invokerå¯¹è±¡åˆ›å»ºçš„å…¨è¿‡ç¨‹"></a>21.5.3 Invokerå¯¹è±¡åˆ›å»ºçš„å…¨è¿‡ç¨‹</h3><p>ä¸ºäº†æ›´å¥½ç†è§£Protocol$Adaptieå†…éƒ¨çš„å¼•ç”¨æ‰§è¡Œè¿‡ç¨‹è¿™é‡Œæˆ‘æŠŠDebugçš„é“¾è·¯æˆªå›¾äº†è¿‡æ¥<br>æŒ‰ç…§å›ºå®šçš„é¡ºåºå…ˆæ‰§è¡ŒAOPçš„é€»è¾‘å†æ‰§è¡Œå…·ä½“çš„é€»è¾‘:</p>
<ul>
<li>Protocol$Adaptieçš„referæ–¹æ³•</li>
<li>ProtocolSerializationWrapper AOPç±»å‹çš„åè®®åºåˆ—åŒ–å™¨referæ–¹æ³•</li>
<li>ProtocolFilterWrapper AOPç±»å‹çš„åè®®è¿‡æ»¤å™¨çš„referæ–¹æ³•</li>
<li>QosProtocolWrapper AOPç±»å‹çš„QOSåè®®åŒ…è£…å™¨çš„referæ–¹æ³•</li>
<li>ProtocolListenerWrapper APOç±»å‹ç›‘å¬å™¨åŒ…è£…å™¨çš„referæ–¹æ³•</li>
<li>RegistryProtocol æ³¨å†Œåè®®çš„referæ–¹æ³• ï¼ˆä¼šæ·»åŠ å®¹é”™é€»è¾‘ï¼‰</li>
<li>RegistryProtocol æ³¨å†Œåè®®çš„doReferæ–¹æ³•ï¼ˆè°ƒç”¨æ–¹æ³•åˆ›å»ºInvokerå¯¹è±¡ï¼‰</li>
</ul>
<p><a href="/img/dubbo/createInvokerRemote.png"></a></p>
<p>è¿™é‡Œæˆ‘ä»¬ä¸å†è¯¦ç»†è¯´è¿™ä¸ªå¼•ç”¨é“¾çš„å…·ä½“è¿‡ç¨‹ç›´æ¥å®šä½åˆ°RegistryProtocolä¸­åˆ›å»ºInvokerç±»å‹çš„åœ°æ–¹ã€‚<br>å…ˆæ¥çœ‹RegistryProtocolç±»å‹çš„referæ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<p>RegistryProtocolç±»å‹çš„referæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token comment">//è¿™ä¸ªurlå·²ç»è¢«è½¬æ¢ä¸ºå…·ä½“çš„æ³¨å†Œä¸­å¿ƒåè®®ç±»å‹äº†</span>
        <span class="token comment">//zookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-consumer&amp;dubbo=2.0.2&amp;pid=7944&amp;qos.enable=false&amp;qos.port=-1&amp;release=3.0.9&amp;timestamp=1657440673100</span>
        url <span class="token operator">=</span> <span class="token function">getRegistryUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–ç”¨äºæ“ä½œZookeeperçš„Registryç±»å‹ </span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegistryService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> registry<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// group="a,b" or group="*"</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> qs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>REFER_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> group <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>GROUP_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>COMMA_SPLIT_PATTERN<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">doRefer</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MergeableCluster</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">,</span> registry<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">,</span> qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//é™çº§å®¹é”™çš„é€»è¾‘å¤„ç†å¯¹è±¡ ç±»å‹ä¸ºCluster å®é™…ç±»å‹ä¸ºMockClusterWrapper å†…éƒ¨åŒ…è£…çš„æ˜¯FailoverCluster</span>
        <span class="token comment">//åç»­è°ƒç”¨æœåŠ¡å¤±è´¥æ—¶å€™ä¼šå…ˆå¤±æ•ˆè½¬ç§»å†é™çº§</span>
        <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> <span class="token class-name">Cluster</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CLUSTER_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿™é‡Œæ‰æ˜¯å…·ä½“çš„Invokerå¯¹è±¡çš„åˆ›å»º</span>
        <span class="token keyword">return</span> <span class="token function">doRefer</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">,</span> qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>RegistryProtocolç±»å‹çš„doReferæ–¹æ³•åˆ›å»ºInvokerå¯¹è±¡<br>ç›´æ¥æ¥çœ‹ä»£ç äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doRefer</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token class-name">Registry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> consumerAttribute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumerAttribute<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>REFER_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> p <span class="token operator">=</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>PROTOCOL_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> CONSUMER <span class="token operator">:</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>PROTOCOL_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">URL</span> consumerUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfigURL</span> <span class="token punctuation">(</span>
           p<span class="token punctuation">,</span>
           <span class="token keyword">null</span><span class="token punctuation">,</span>
           <span class="token keyword">null</span><span class="token punctuation">,</span>
           parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>REGISTER_IP_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">getPath</span><span class="token punctuation">(</span>parameters<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">,</span>
           parameters<span class="token punctuation">,</span>
           consumerAttribute
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
       url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">putAttribute</span><span class="token punctuation">(</span>CONSUMER_URL_KEY<span class="token punctuation">,</span> consumerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//é‡ç‚¹çœ‹è¿™ä¸€è¡Œ å¸¦è¿ç§»æ€§è´¨çš„Invokerå¯¹è±¡</span>
       <span class="token class-name">ClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> migrationInvoker <span class="token operator">=</span> <span class="token function">getMigrationInvoker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">,</span> consumerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//è¿™ä¸€è¡Œå›æ¥æ‰§è¡Œè¿ç§»è§„åˆ™åˆ›å»ºåº”ç”¨çº§ä¼˜å…ˆçš„æœåŠ¡å‘ç°Invokerå¯¹è±¡</span>
       <span class="token keyword">return</span> <span class="token function">interceptInvoker</span><span class="token punctuation">(</span>migrationInvoker<span class="token punctuation">,</span> url<span class="token punctuation">,</span> consumerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œä»£ç æ¯”è¾ƒé‡è¦çš„å…¶å®åªæœ‰ä¸¤è¡ŒgetMigrationInvokerå’ŒinterceptInvokeræ–¹æ³•<br>æ¯”è¾ƒæ ¸å¿ƒä¹Ÿæ˜¯Dubbo3æ¯”è¾ƒé‡è¦çš„æ¶ˆè´¹è€…å¯åŠ¨é€»è¾‘åŸºæœ¬éƒ½åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢interceptInvokerï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œäº†æ¶ˆè´¹è€…åº”ç”¨çº§å‘ç°å’Œæ¥å£çº§å‘ç°è¿ç§»çš„é€»è¾‘ï¼Œä¼šè‡ªåŠ¨å¸®å¿™å†³ç­–ä¸€ä¸ªInvokerç±»å‹å¯¹è±¡ï¼Œä¸è¿‡è¿™ä¸ªé€»è¾‘è¿™é‡Œå…ˆç®€å•çœ‹ä¸‹ï¼Œåç»­å•ç‹¬æ•´ä¸ªæ–‡ç« æ¥è¯´ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆæ¥çœ‹ ClusterInvokerå¯¹è±¡çš„åˆ›å»ºï¼Œä¸‹é¢å…ˆçœ‹ä»£ç ï¼š</p>
<p>RegistryProtocolç±»å‹çš„getMigrationInvokeræ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMigrationInvoker</span><span class="token punctuation">(</span><span class="token class-name">RegistryProtocol</span> registryProtocol<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token class-name">Registry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">URL</span> consumerUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceDiscoveryMigrationInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>registryProtocol<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">,</span> consumerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¯¦ç»†çš„é€»è¾‘è¿™é‡Œå°±ä¸å†çœ‹äº†ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹RegistryProtocolç±»å‹çš„interceptInvokeræ–¹æ³•ï¼š</p>
<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š<br>RegistryProtocolç±»å‹çš„interceptInvokeræ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">interceptInvoker</span><span class="token punctuation">(</span><span class="token class-name">ClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">URL</span> consumerUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//è·å–æ¿€æ´»çš„æ³¨å†Œåè®®ç›‘å¬å™¨æ‰©å±•é‡Œé¢registry.protocol.listenerï¼Œè¿™é‡Œæ¿€æ´»çš„ç±»å‹ä¸ºMigrationRuleListener</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegistryProtocolListener</span><span class="token punctuation">&gt;</span></span> listeners <span class="token operator">=</span> <span class="token function">findRegistryProtocolListeners</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>listeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RegistryProtocolListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//è¿™é‡Œæ‰§è¡ŒMigrationRuleListenerç±»å‹çš„onReferæ–¹æ³•</span>
           listener<span class="token punctuation">.</span><span class="token function">onRefer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> invoker<span class="token punctuation">,</span> consumerUrl<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥æ–¹æ³•å°è¯•åŠ è½½æ‰€æœ‰RegistryProtocolListenerå®šä¹‰ï¼Œè¿™äº›å®šä¹‰é€šè¿‡ä¸å®šä¹‰çš„äº¤äº’æ¥æ§åˆ¶è°ƒç”¨å™¨çš„è¡Œä¸ºï¼Œç„¶åä½¿ç”¨è¿™äº›ä¾¦å¬å™¨æ›´æ”¹MigrationInvokerçš„çŠ¶æ€å’Œè¡Œä¸ºã€‚<br>å½“å‰å¯ç”¨çš„ç›‘å¬å™¨æ˜¯MigrationRuleListenerï¼Œç”¨äºé€šè¿‡åŠ¨æ€å˜åŒ–çš„è§„åˆ™æ§åˆ¶è¿ç§»è¡Œä¸ºã€‚</p>
<p>å¯ä»¥çœ‹åˆ°æ ¸å¿ƒçš„é€»è¾‘é›†ä¸­åœ¨äº†è¿™ä¸ªä½ç½®MigrationRuleListenerç±»å‹çš„onReferæ–¹æ³•ï¼Œè¿™ä¸ªè¿™é‡Œå°±ä¸æ·±å…¥å¾€ä¸‹è¯´äº†ï¼Œåç»­ä¼šæœ‰ä¸ªæ–‡ç« ä¸“é—¨æ¥çœ‹Dubbo2è¿ç§»Dubbo3æ—¶å€™å¤„ç†çš„é€»è¾‘ã€‚</p>
<p>Invokerå¯¹è±¡çš„åˆ›å»ºå®Œæˆå…¶å®å°±ä»£è¡¨äº†æœåŠ¡å¼•ç”¨æ‰§è¡Œå®Œæˆï¼Œä¸è¿‡è¿™é‡Œæ ¸å¿ƒçš„åè®®å¹¶æ²¡æœ‰æ¥è¯´</p>

			<br>
			
			
			<a class="tag-unordered list-link" href="/tags/Dubbo/" rel="tag">Dubbo<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3/" rel="tag">Dubbo3<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">Dubbo3æºç è§£æ<span class="tag-unordered list-count">23</span></a>

			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
        
    

    
         <!-- å…ˆæ‰¾åˆ°ä¸å½“å‰æ–‡å­—ç›¸åŒçš„ç›®å½• -->
            
            
                 
                
            
                 
                
            
                 
                 <!-- åœ¨æ‰¾åˆ°å½“å‰æ–‡ç« æ‰€åœ¨çš„ index -->
                    
                    
                         

                        

                        

                    
                         

                        

                         <!-- ä¸‹ä¸€ç¯‡æ–‡ç«  --> 
                            <div class="new">
                                <span>ä¸‹ä¸€ç« </span>
                                <a href="/2022/07/10/dubbo/22-dubbo3-xiao-fei-zhe-zi-dong-gan-ying-jue-ce-ying-yong-ji-fu-wu-fa-xian-yuan-li/"> 22-ã€Dubbo3.0.8æºç è§£æç³»åˆ—ã€‘Dubbo3æ¶ˆè´¹è€…è‡ªåŠ¨æ„Ÿåº”å†³ç­–åº”ç”¨çº§æœåŠ¡å‘ç°åŸç†</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- ä¸Šä¸€ç¯‡æ–‡ç«  --> 
                            <div class="old">
                                <span>ä¸Šä¸€ç« </span>
                                <a href="/2022/07/10/dubbo/20-dubbo3-fu-wu-yin-yong-pei-zhi-referenceconfig/"> 20-ã€Dubbo3.0.8æºç è§£æç³»åˆ—ã€‘Dubbo3æœåŠ¡å¼•ç”¨é…ç½®ReferenceConfig</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // ä½¿ç”¨æ–¹æ³• https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'OrwF9gExPcH3pyeb35WIuKun-9Nh9j0Va',
        appKey: 'W098QAVm3hxbnBWRpho3a6HN'
    })
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">ä¸­é—´ä»¶æºç </div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                </div>
                <div calss="footer-copyright">&copy; 2022 ä¸­é—´ä»¶æºç 
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
