<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		
<title>16-【Dubbo3.0.8源码解析系列】模块发布器发布服务全过程 - 中间件源码</title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 6.2.0">
<link rel="stylesheet" href="/css/style.css?v=1662256562115">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1662256562115"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?2ee30baeebf59e698360da94012edd15';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="中间件源码" type="application/atom+xml">
</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="中间件源码">中间件源码</a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/index.html">首页</a></li>
            
                <li class="nav-item"><a href="/categories">分类</a></li>
            
                <li class="nav-item"><a href="/about.html">About</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>16-【Dubbo3.0.8源码解析系列】模块发布器发布服务全过程</h1>
			<div class="info"><span class="date">2022年7月10日</span>•songxiaosheng 
			
					《<a class="nexmoefont icon-appstore-fill -link" href="/categories/Dubbo3%E6%BA%90%E7%A0%81/">Dubbo3源码</a>》
				
				<!-- 
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/dubbo/16-模块发布器发布服务全过程.md" target="_blank" rel="external nofollow noreferrer noopener">编辑</a>
				 -->
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="16-模块发布器发布服务全过程"><a href="#16-模块发布器发布服务全过程" class="headerlink" title="16-模块发布器发布服务全过程"></a>16-模块发布器发布服务全过程</h1><h2 id="16-1-简介"><a href="#16-1-简介" class="headerlink" title="16.1 简介"></a>16.1 简介</h2><p>Dubbo做为服务治理框架,比较核心的就是服务相关的概念,这里我先贴个找到的关于Dubbo工作原理的架构图:<br> <img src="https://img-blog.csdnimg.cn/99dc42c8fbaf4ac8afe9df36ed98105c.png" alt="在这里插入图片描述"><br> 如果按完整服务启动与订阅的顺序我们可以归结为以下6点:</p>
<ul>
<li>导出服务(提供者)<ul>
<li>服务提供方通过指定端口对外暴露服务</li>
</ul>
</li>
<li>注册服务(提供者)<ul>
<li>提供方向注册中心注册自己的信息</li>
</ul>
</li>
<li>(服务发现)-订阅服务(消费者)<ul>
<li>服务调用方通过注册中心订阅自己感兴趣的服务</li>
</ul>
</li>
<li>(服务发现)-服务推送(消费者)<ul>
<li>注册中心向调用方推送地址列表</li>
</ul>
</li>
<li>调用服务(消费者调用提供者)<ul>
<li>调用方选择一个地址发起RPC调用</li>
</ul>
</li>
<li>监控服务<ul>
<li>服务提供方和调用方的统计数据由监控模块收集展示</li>
</ul>
</li>
</ul>
<p>上面的完整的服务启动订阅与调用流程不仅仅适用于Dubbo 同样也适用于其他服务治理与发现的模型, 一般服务发现与服务调用的思路就是这样的,我们将以上内容扩展,暴漏服务可以使用http,tcp,udp等各种协议,注册服务可以注册到Redis,Dns,Etcd,Zookeeper等注册中心中,订阅服务可以主动去注册中心查询服务列表,服务发现可以让注册中心将服务数据动态推送给消费者.Dubbo其实就是基于这种简单的服务模型来扩展出各种功能的支持,来满足服务治理的各种场景,了解了这里可能各位同学就想着自行开发一个简单的微服务框架了。</p>
<p>回到主题,从以上的服务完整发布调用流程可以看到,所有的功能都是由导出服务(提供者)开始的,只有提供者先提供了服务才可以有真正的服务让消费者调用。</p>
<p>之前的博客内容 链接:<a target="_blank" rel="noopener" href="https://blog.csdn.net/songjunyan/article/details/124779102">&lt;&lt;12-全局视野来看Dubbo3.0.8的服务启动生命周期&gt;&gt;</a> 我们了解了 DefaultModuleDeployer模块器启动的流程,其中在start代码的模版方法中开始了导出服务的功能,这里我们来详细看下服务发布的全过程:</p>
<p>入口代码: DefaultModuleDeployer的发布服务方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//从配置管缓存中查询缓存的所有的服务配置然后逐个服务发布</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceConfigBase</span> sc <span class="token operator">:</span> configManager<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">exportServiceInternal</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="16-2-导出服务的入口"><a href="#16-2-导出服务的入口" class="headerlink" title="16.2 导出服务的入口"></a>16.2 导出服务的入口</h2><p>入口代码: DefaultModuleDeployer的发布服务方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//从配置管缓存中查询缓存的所有的服务配置然后逐个服务发布</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceConfigBase</span> sc <span class="token operator">:</span> configManager<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">exportServiceInternal</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要流程为遍历初始化的服务配置列表然后逐个服务开始到处<br>内部导出服务代码:<br>exportServiceInternal方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportServiceInternal</span><span class="token punctuation">(</span><span class="token class-name">ServiceConfigBase</span> sc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
       <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> sc<span class="token punctuation">;</span>
       <span class="token comment">//服务配置刷新 配置优先级覆盖</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceConfig<span class="token punctuation">.</span><span class="token function">isRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           serviceConfig<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//服务已经导出过了就直接返回</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">isExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//是否异步方式导出 全局配置或者服务级其中一个配置了异步则异步处理</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>exportAsync <span class="token operator">||</span> sc<span class="token punctuation">.</span><span class="token function">shouldExportAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//异步其实就是使用线程来导出服务serviceExportExecutor</span>
           <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> executorRepository<span class="token punctuation">.</span><span class="token function">getServiceExportExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
               <span class="token keyword">try</span> <span class="token punctuation">{</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sc<span class="token punctuation">.</span><span class="token function">isExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       sc<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       exportedServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" export async catch error : "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

           asyncExportingFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       	<span class="token comment">//同步导出服务</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sc<span class="token punctuation">.</span><span class="token function">isExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               sc<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               exportedServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个逻辑里面做了一些基本的操作,可以直接看注释然后调用ServiceConfig的export的来导出服务,继续往后看服务配置的导出服务方法。</p>
<h2 id="16-3-服务配置导出服务模板方法"><a href="#16-3-服务配置导出服务模板方法" class="headerlink" title="16.3 服务配置导出服务模板方法"></a>16.3 服务配置导出服务模板方法</h2><p>核心的服务导出代码是在服务配置中来做的ServiceConfig的 export() 方法<br>ServiceConfig的 export() 方法代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//已经导出过服务直接放那会</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ensure start module, compatible with old api usage</span>
      <span class="token comment">//确保模块启动了(基本的初始化操作执行了)</span>
      <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeployer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//悲观锁</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//双重校验</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
	<span class="token comment">//配置是否刷新 前面初始化时候已经刷新过配置</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">//服务导出配置配置为false则不导出</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">//服务发布前初始化一下元数据对象</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//配置了服务的延迟发布配置则走延迟发布逻辑</span>
                  <span class="token function">doDelayExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              	<span class="token comment">//导出服务</span>
                  <span class="token function">doExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-3-1-服务配置导出服务前的初始化方法"><a href="#16-3-1-服务配置导出服务前的初始化方法" class="headerlink" title="16.3.1 服务配置导出服务前的初始化方法"></a>16.3.1 服务配置导出服务前的初始化方法</h3><p>ServiceConfig 导出服务之前的初始化方法init</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initialized<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">//加载服务监听器 这里暂时没有服务监听器扩展</span>
            <span class="token comment">// load ServiceListeners from extension</span>
            <span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceListener</span><span class="token punctuation">&gt;</span></span> extensionLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ServiceListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceListeners<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>extensionLoader<span class="token punctuation">.</span><span class="token function">getSupportedExtensionInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//服务提供者配置传递给元数据配置对象 一个服务提供者配置会有一个元数据配置，服务配置</span>
        <span class="token function">initServiceMetadata</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//元数据</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">setServiceType</span><span class="token punctuation">(</span><span class="token function">getInterfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        serviceMetadata<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span><span class="token function">getRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//元数据的key格式为 group/服务接口:版本号</span>
        serviceMetadata<span class="token punctuation">.</span><span class="token function">generateServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="16-4-服务配置导出服务模板方法2"><a href="#16-4-服务配置导出服务模板方法2" class="headerlink" title="16.4 服务配置导出服务模板方法2"></a>16.4 服务配置导出服务模板方法2</h2><p>ServiceConfig 导出服务核心逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//取消发布</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unexported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The service "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" has already unexported!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//已经发布</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//服务路径 为空则设置为接口名，本例子中为link.elastic.dubbo.entity.DemoService</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            path <span class="token operator">=</span> interfaceName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//导出URL</span>
        <span class="token function">doExportUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
        <span class="token function">exported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-4-1-导出服务的URL配置逻辑"><a href="#16-4-1-导出服务的URL配置逻辑" class="headerlink" title="16.4.1 导出服务的URL配置逻辑"></a>16.4.1 导出服务的URL配置逻辑</h3><p>ServiceConfig 导出URL核心逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doExportUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//模块服务存储库</span>
       <span class="token class-name">ModuleServiceRepository</span> repository <span class="token operator">=</span> <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">ServiceDescriptor</span> serviceDescriptor<span class="token punctuation">;</span>
       <span class="token comment">//ref为服务实现类型 这里对应我们例子的DemoServiceImpl</span>
       <span class="token keyword">final</span> <span class="token keyword">boolean</span> serverService <span class="token operator">=</span> ref <span class="token keyword">instanceof</span> <span class="token class-name">ServerService</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>serverService<span class="token punctuation">)</span><span class="token punctuation">{</span>
           serviceDescriptor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServerService</span><span class="token punctuation">)</span> ref<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           repository<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
       	<span class="token comment">//我们代码走这个逻辑 注册服务 这个注册不是向注册中心注册 这个是解析服务接口将服务方法等描述信息存放在了服务存储ModuleServiceRepository类型对象的成员变量services中</span>
           serviceDescriptor <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span><span class="token function">getInterfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//提供者领域模型， 提供者领域模型 封装了一些提供者需要的就基本属性同时内部解析封装方法信息 ProviderMethodModel 列表 ， 服务标识符 格式group/服务接:版本号</span>
       providerModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderModel</span><span class="token punctuation">(</span><span class="token function">getUniqueServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       	<span class="token comment">//服务实现类DemoServiceImpl</span>
           ref<span class="token punctuation">,</span>
           <span class="token comment">//服务描述符 描述符里面包含了服务接口的方法信息，不过服务接口通过反射也可以拿到方法信息</span>
           serviceDescriptor<span class="token punctuation">,</span>
           <span class="token comment">//服务配置</span>
           <span class="token keyword">this</span><span class="token punctuation">,</span>
           <span class="token comment">//当前所处模型</span>
           <span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token comment">//当前服务接口的元数据对象</span>
           serviceMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//模块服务存储库存储提供者模型对象ModuleServiceRepository</span>
       repository<span class="token punctuation">.</span><span class="token function">registerProvider</span><span class="token punctuation">(</span>providerModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取配置的注册中心列表 ，同时将注册中心配置转URL （在Dubbo中URL就是配置信息的一种形式）</span>
	<span class="token comment">//这里会获取到两个  由dubbo.application.register-mode 双注册配置决定</span>
	<span class="token comment">//注册中心 registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=9008&amp;registry=zookeeper&amp;release=3.0.8&amp;timestamp=1653703292768</span>
  <span class="token comment">//service-discovery-registry://8.131.79.126:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=10275&amp;registry=zookeeper&amp;release=3.0.8&amp;timestamp=1653704425920</span>
  <span class="token comment">//参数dubbo是dubbo协议的版本不是Dubbo版本 Dubbo RPC protocol version, for compatibility, it must not be between 2.0.10 ~ 2.6.2</span>
   <span class="token comment">//这里后面详细说下 服务双注册  dubbo.application.register-mode</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs <span class="token operator">=</span> <span class="token class-name">ConfigValidationUtils</span><span class="token punctuation">.</span><span class="token function">loadRegistries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolConfig</span> protocolConfig <span class="token operator">:</span> protocols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">String</span> pathKey <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span><span class="token function">getContextPath</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> p <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> path<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// stub service will use generated service name</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>serverService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// In case user specified path, register service one more time to map it to path.</span>
               <span class="token comment">//模块服务存储库ModuleServiceRepository存储服务接口信息</span>
              repository<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>pathKey<span class="token punctuation">,</span> interfaceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//导出根据协议导出配置到注册中心</span>
           <span class="token function">doExportUrlsFor1Protocol</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">,</span> registryURLs<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="16-4-2-应用级和接口级服务注册地址获取"><a href="#16-4-2-应用级和接口级服务注册地址获取" class="headerlink" title="16.4.2 应用级和接口级服务注册地址获取"></a>16.4.2 应用级和接口级服务注册地址获取</h3><p>这里主要看下注册中心的获取，这里涉及到服务的双注册配置</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs <span class="token operator">=</span> <span class="token class-name">ConfigValidationUtils</span><span class="token punctuation">.</span><span class="token function">loadRegistries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>关于loadRegistries方法的详情我们就不看了主要看loadRegistries方法中调用的genCompatibleRegistries添加服务发现注册中心</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token comment">/**
   * @param scopeModel 域模型
   * @param registryList 配置的注册中心列表 例如：registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=9008&amp;registry=zookeeper&amp;release=3.0.8&amp;timestamp=1653703292768
   * 
   *  @param provider 是否为服务提供者 这里Demo为true
   */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">genCompatibleRegistries</span><span class="token punctuation">(</span><span class="token class-name">ScopeModel</span> scopeModel<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryList<span class="token punctuation">,</span> <span class="token keyword">boolean</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>registryList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历所有的注册中心 为每个注册中心增加兼容的服务发现注册中心地址配置</span>
        registryList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>registryURL <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
           <span class="token comment">//是否为提供者 </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// for registries enabled service discovery, automatically register interface compatible addresses.</span>
                
                <span class="token class-name">String</span> registerMode<span class="token punctuation">;</span>
                <span class="token comment">//注册协议配置了service-discovery-registry 走这个逻辑</span>
                <span class="token comment">//前面这个逻辑是直接接给result结果中添加应用级注册，如果是all配置则增加接口级注册信息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>SERVICE_REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    registerMode <span class="token operator">=</span> registryURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REGISTER_MODE_KEY<span class="token punctuation">,</span> <span class="token class-name">ConfigurationUtils</span><span class="token punctuation">.</span><span class="token function">getCachedDynamicProperty</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">,</span> DUBBO_REGISTER_MODE_DEFAULT_KEY<span class="token punctuation">,</span> DEFAULT_REGISTER_MODE_INSTANCE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidRegisterMode</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        registerMode <span class="token operator">=</span> DEFAULT_REGISTER_MODE_INSTANCE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//这里配置的就是应用级配置 则先添加应用级地址，再根据条件判断是否添加接口级注册中心地址</span>
                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEFAULT_REGISTER_MODE_ALL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token function">registryNotExists</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">,</span> registryList<span class="token punctuation">,</span> REGISTRY_PROTOCOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">URL</span> interfaceCompatibleRegistryURL <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>REGISTRY_PROTOCOL<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">removeParameter</span><span class="token punctuation">(</span>REGISTRY_TYPE_KEY<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interfaceCompatibleRegistryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                	<span class="token comment">//正常情况下我们的配置会走这个逻辑</span>
                	<span class="token comment">// 获取服务注册的注册模式 配置为dubbo.application.register-mode 默认值为all 既注册接口数据又注册应用级信息</span>
                    registerMode <span class="token operator">=</span> registryURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REGISTER_MODE_KEY<span class="token punctuation">,</span> <span class="token class-name">ConfigurationUtils</span><span class="token punctuation">.</span><span class="token function">getCachedDynamicProperty</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">,</span> DUBBO_REGISTER_MODE_DEFAULT_KEY<span class="token punctuation">,</span> DEFAULT_REGISTER_MODE_ALL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidRegisterMode</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        registerMode <span class="token operator">=</span> DEFAULT_REGISTER_MODE_INTERFACE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                     <span class="token comment">//根据逻辑条件判断是否添加应用级注册中心地址</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DEFAULT_REGISTER_MODE_INSTANCE<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span> <span class="token operator">||</span> DEFAULT_REGISTER_MODE_ALL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token function">registryNotExists</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">,</span> registryList<span class="token punctuation">,</span> SERVICE_REGISTRY_PROTOCOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">URL</span> serviceDiscoveryRegistryURL <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>SERVICE_REGISTRY_PROTOCOL<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">removeParameter</span><span class="token punctuation">(</span>REGISTRY_TYPE_KEY<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>serviceDiscoveryRegistryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
   					<span class="token comment">//根据逻辑条件判断是否添加接口级注册中心地址</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEFAULT_REGISTER_MODE_INTERFACE<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span> <span class="token operator">||</span> DEFAULT_REGISTER_MODE_ALL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">FrameworkStatusReportService</span> reportService <span class="token operator">=</span> <span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getApplicationModel</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">FrameworkStatusReportService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reportService<span class="token punctuation">.</span><span class="token function">reportRegistrationStatus</span><span class="token punctuation">(</span>reportService<span class="token punctuation">.</span><span class="token function">createRegistrationReport</span><span class="token punctuation">(</span>registerMode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法是根据服务注册模式来判断使用接口级注册地址还是应用级注册地址分别如下所示：<br>配置信息：<br>dubbo.application.register-mode<br>配置值：</p>
<ul>
<li>interface<ul>
<li>接口级注册</li>
</ul>
</li>
<li>instance<ul>
<li>应用级注册</li>
</ul>
</li>
<li>all <ul>
<li>接口级别和应用级都注册</li>
</ul>
</li>
</ul>
<p>接口级注册地址：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">9008</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653703292768</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>应用级注册地址：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">service<span class="token operator">-</span>discovery<span class="token operator">-</span>registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">8.131</span><span class="token number">.79</span><span class="token number">.126</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">10275</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653704425920</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>







<h2 id="16-5-导出服务配置到本地和注册中心"><a href="#16-5-导出服务配置到本地和注册中心" class="headerlink" title="16.5 导出服务配置到本地和注册中心"></a>16.5 导出服务配置到本地和注册中心</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">doExportUrlsFor1Protocol</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">,</span> registryURLs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>protocolConfig为：dubbo协议的配置<br>&lt;dubbo:protocol port=”-1” name=”dubbo” /&gt;</p>
<p>registryURLs目前有两个 应用级注册地址和接口级注册地址：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">9008</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653703292768</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java">service<span class="token operator">-</span>discovery<span class="token operator">-</span>registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">8.131</span><span class="token number">.79</span><span class="token number">.126</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">10275</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653704425920</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="16-5-1-导出服务配置的doExportUrlsFor1Protocol方法"><a href="#16-5-1-导出服务配置的doExportUrlsFor1Protocol方法" class="headerlink" title="16.5.1 导出服务配置的doExportUrlsFor1Protocol方法"></a>16.5.1 导出服务配置的doExportUrlsFor1Protocol方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doExportUrlsFor1Protocol</span><span class="token punctuation">(</span><span class="token class-name">ProtocolConfig</span> protocolConfig<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//生成协议配置具体可见下图中的元数据配置中的attachments</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token function">buildAttributes</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// remove null key and null value</span>
      <span class="token comment">//移除空值 简化配置</span>
      map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// init serviceMetadata attachments</span>
      <span class="token comment">//协议配置放到元数据对象中</span>
      serviceMetadata<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">//协议配置 + 默认协议配置转URL类型的配置存储</span>
      <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token function">buildUrl</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//导出url</span>
      <span class="token function">exportUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> registryURLs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <img src="https://img-blog.csdnimg.cn/3471f6ca998c49b4be6c5c04ee21acf2.png" alt="在这里插入图片描述"></p>
<h3 id="16-5-2-导出服务配置模板方法"><a href="#16-5-2-导出服务配置模板方法" class="headerlink" title="16.5.2 导出服务配置模板方法"></a>16.5.2 导出服务配置模板方法</h3><p>继续看导出服务的模板方法，分为本地导出和注册中心导出<br>//参数url为协议配置url可以参考：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">dubbo<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.9</span><span class="token operator">:</span><span class="token number">20880</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">link<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span>DemoService</span><span class="token operator">?</span>anyhost<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>background<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>bind<span class="token punctuation">.</span>ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.9</span><span class="token operator">&amp;</span>bind<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">20880</span><span class="token operator">&amp;</span>deprecated<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>dynamic<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>generic<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span><span class="token keyword">interface</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">link<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span>DemoService</span><span class="token operator">&amp;</span>methods<span class="token operator">=</span>sayHello<span class="token punctuation">,</span>sayHelloAsync<span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">10953</span><span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>side<span class="token operator">=</span>provider<span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653705630518</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportUrl</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> scope <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>SCOPE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// don't export when none is configured</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCOPE_NONE<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// export to local if the config is not remote (export to remote only when config is remote)</span>
            <span class="token comment">//未明确指定远程导出 则开启本地导出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCOPE_REMOTE<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exportLocal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//未明确指定本地导出 则开启远程导出</span>
            <span class="token comment">// export to remote if the config is not local (export to local only when config is local)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCOPE_LOCAL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                url <span class="token operator">=</span> <span class="token function">exportRemote</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> registryURLs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isGeneric</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">MetadataUtils</span><span class="token punctuation">.</span><span class="token function">publishServiceDefinition</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> providerModel<span class="token punctuation">.</span><span class="token function">getServiceModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getApplicationModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="16-6-导出服务到本地"><a href="#16-6-导出服务到本地" class="headerlink" title="16.6 导出服务到本地"></a>16.6 导出服务到本地</h2><p>本地调用使用了 injvm 协议，是一个伪协议，它不开启端口，不发起远程调用，只在 JVM 内直接关联，但执行 Dubbo 的 Filter 链。</p>
<p>直接通过代码来看吧</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportLocal</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//协议转为injvm 代表本地导出 host为127.0.0.1</span>
       <span class="token class-name">URL</span> local <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>LOCAL_PROTOCOL<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span>LOCALHOST_VALUE<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">setServiceModel</span><span class="token punctuation">(</span>providerModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">doExportUrl</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Export dubbo service "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" to local registry url : "</span> <span class="token operator">+</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-6-1-doExportUrl方法"><a href="#16-6-1-doExportUrl方法" class="headerlink" title="16.6.1 doExportUrl方法"></a>16.6.1 doExportUrl方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doExportUrl</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token keyword">boolean</span> withMetaData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//这里是由adaptor扩展类型处理过的 我们直接看默认的类型javassist 对应JavassistProxyFactory代理工厂 获取调用对象 （</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>withMetaData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocolSPI<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-6-2-JavassistProxyFactory类型的getInvoker方法"><a href="#16-6-2-JavassistProxyFactory类型的getInvoker方法" class="headerlink" title="16.6.2 JavassistProxyFactory类型的getInvoker方法"></a>16.6.2 JavassistProxyFactory类型的getInvoker方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO Wrapper cannot handle this scenario correctly: the classname contains '$'</span>
            <span class="token comment">// 创建实际服务提供者的代理类型，代理类型后缀为DubboWrap在这里类型为 link.elastic.dubbo.entity.DemoServiceImplDubboWrap0</span>
            <span class="token keyword">final</span> <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> <span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建一个匿名内部类对象 继承自AbstractProxyInvoker的Invoker对象</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AbstractProxyInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span>
                                          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span>
                                          <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> wrapper<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> fromJavassist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// try fall back to JDK proxy factory</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-6-3-使用协议导出调用对象-export"><a href="#16-6-3-使用协议导出调用对象-export" class="headerlink" title="16.6.3 使用协议导出调用对象 export"></a>16.6.3 使用协议导出调用对象 export</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocolSPI<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个使用了Adaptor扩展和Wrapper机制Debug起来不太方便这里贴一下调用堆栈<img src="https://img-blog.csdnimg.cn/1ad83cdda91647279af4ff99f433e39d.png" alt="在这里插入图片描述"></p>
<h3 id="16-6-3-1-协议序列化机制ProtocolSerializationWrapper"><a href="#16-6-3-1-协议序列化机制ProtocolSerializationWrapper" class="headerlink" title="16.6.3.1 协议序列化机制ProtocolSerializationWrapper"></a>16.6.3.1 协议序列化机制ProtocolSerializationWrapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
     <span class="token comment">//这里主要逻辑是将服务提供者url添加到服务存储仓库中</span>
     <span class="token function">getFrameworkModel</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerProviderUrl</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="16-6-3-2-协议过滤器Wrapper-ProtocolFilterWrapper"><a href="#16-6-3-2-协议过滤器Wrapper-ProtocolFilterWrapper" class="headerlink" title="16.6.3.2 协议过滤器Wrapper ProtocolFilterWrapper"></a>16.6.3.2 协议过滤器Wrapper ProtocolFilterWrapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
       <span class="token comment">//注册中心的协议导出直接执行</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//过滤器调用链FilterChainBuilder的扩展对象查询</span>
       <span class="token class-name">FilterChainBuilder</span> builder <span class="token operator">=</span> <span class="token function">getFilterChainBuilder</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//这里分为2步 生成过滤器调用链 然后使用链表中的节点调用  这里值查询provider类型的过滤器</span>
       <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> SERVICE_FILTER_KEY<span class="token punctuation">,</span> <span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>PROVIDER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤器调用链的生成 对用DefaultFilterChainBuilder类型的buildInvokerChain方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> originalInvoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">//originalInvoker代表真正的服务调用器</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> last <span class="token operator">=</span> originalInvoker<span class="token punctuation">;</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> originalInvoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleModel</span><span class="token punctuation">&gt;</span></span> moduleModels <span class="token operator">=</span> <span class="token function">getModuleModelsFromUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleModels <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> moduleModels<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//类型Filter key为service.filter 分组为provider 所有提供者过滤器拉取</span>
            filters <span class="token operator">=</span> <span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> moduleModels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleModels <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> moduleModels<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            filters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionDirector</span><span class="token punctuation">&gt;</span></span> directors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ModuleModel</span> moduleModel <span class="token operator">:</span> moduleModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> tempFilters <span class="token operator">=</span> <span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> moduleModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
                filters<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>tempFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                directors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>moduleModel<span class="token punctuation">.</span><span class="token function">getExtensionDirector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            filters <span class="token operator">=</span> <span class="token function">sortingAndDeduplication</span><span class="token punctuation">(</span>filters<span class="token punctuation">,</span> directors<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            filters <span class="token operator">=</span> <span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//倒序拼接，将过滤器的调用对象添加到链表中  最后倒序遍历之后 last节点指向了调用链路链表头节点的对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> last<span class="token punctuation">;</span>
                <span class="token comment">//每个invoker对象中都有originalInvoker对象</span>
                last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOfFilterChainNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>originalInvoker<span class="token punctuation">,</span> next<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CallbackRegistrationInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>last<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/e05c16e894bf4889a5fb2876c9daf4e2.png" alt="在这里插入图片描述"></p>
<h3 id="16-6-3-3-协议监听器Wrapper-ProtocolListenerWrapper"><a href="#16-6-3-3-协议监听器Wrapper-ProtocolListenerWrapper" class="headerlink" title="16.6.3.3 协议监听器Wrapper ProtocolListenerWrapper"></a>16.6.3.3 协议监听器Wrapper ProtocolListenerWrapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
       <span class="token comment">//注册中心地址则直接导出</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// 先导出对象 再创建过滤器包装对象 执行监听器逻辑</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ListenerExporterWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span><span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ExporterListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EXPORTER_LISTENER_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-6-3-4-QOS的协议Wrapper-QosProtocolWrapper"><a href="#16-6-3-4-QOS的协议Wrapper-QosProtocolWrapper" class="headerlink" title="16.6.3.4 QOS的协议Wrapper QosProtocolWrapper"></a>16.6.3.4 QOS的协议Wrapper QosProtocolWrapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
         <span class="token comment">//注册中心导出的时候开启QOS 默认端口22222</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startQosServer</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="16-6-3-5-InjvmProtocol-的导出方法"><a href="#16-6-3-5-InjvmProtocol-的导出方法" class="headerlink" title="16.6.3.5 InjvmProtocol 的导出方法"></a>16.6.3.5 InjvmProtocol 的导出方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InjvmExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="16-7-导出服务到注册中心"><a href="#16-7-导出服务到注册中心" class="headerlink" title="16.7 导出服务到注册中心"></a>16.7 导出服务到注册中心</h2><p> 16.5.2 导出服务配置模板方法 中我们看到了服务导出会导出到本地和远程，接下来就看下导出到远程的方法exportRemote<br> 参数url:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">dubbo<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.9</span><span class="token operator">:</span><span class="token number">20880</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">link<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span>DemoService</span><span class="token operator">?</span>anyhost<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>background<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>bind<span class="token punctuation">.</span>ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.9</span><span class="token operator">&amp;</span>bind<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">20880</span><span class="token operator">&amp;</span>deprecated<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>dynamic<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>generic<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span><span class="token keyword">interface</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">link<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span>DemoService</span><span class="token operator">&amp;</span>methods<span class="token operator">=</span>sayHello<span class="token punctuation">,</span>sayHelloAsync<span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">12865</span><span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>side<span class="token operator">=</span>provider<span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653708351378</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数registryURLs目前有两个 应用级注册地址和接口级注册地址：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">9008</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653703292768</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java">service<span class="token operator">-</span>discovery<span class="token operator">-</span>registry<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">8.131</span><span class="token number">.79</span><span class="token number">.126</span><span class="token operator">:</span><span class="token number">2181</span><span class="token operator">/</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>RegistryService</span><span class="token operator">?</span>application<span class="token operator">=</span>dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider<span class="token operator">&amp;</span>dubbo<span class="token operator">=</span><span class="token number">2.0</span><span class="token number">.2</span><span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token number">10275</span><span class="token operator">&amp;</span>registry<span class="token operator">=</span>zookeeper<span class="token operator">&amp;</span>release<span class="token operator">=</span><span class="token number">3.0</span><span class="token number">.8</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1653704425920</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">URL</span> <span class="token function">exportRemote</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>registryURLs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">//遍历所有注册地址与注册模式 逐个注册</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>URL registryURL <span class="token operator">:</span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//为协议URL 添加应用级注册service-discovery-registry参数service-name-mapping为true</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>SERVICE_REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>SERVICE_NAME_MAPPING_KEY<span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//if protocol is only injvm ,not register</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOCAL_PROTOCOL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">//为协议url 添加动态配置dynamic</span>
                url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>DYNAMIC_KEY<span class="token punctuation">,</span> registryURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>DYNAMIC_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//监控配置暂时为null</span>
                <span class="token class-name">URL</span> monitorUrl <span class="token operator">=</span> <span class="token class-name">ConfigValidationUtils</span><span class="token punctuation">.</span><span class="token function">loadMonitor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> registryURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>monitorUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">putAttribute</span><span class="token punctuation">(</span>MONITOR_KEY<span class="token punctuation">,</span> monitorUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// For providers, this is used to enable custom proxy to generate invoker</span>
                <span class="token class-name">String</span> proxy <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>PROXY_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    registryURL <span class="token operator">=</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span>PROXY_KEY<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

				<span class="token comment">//开始注册服务了 打印个认知 提示下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REGISTER_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Register dubbo service "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" url "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" to registry "</span> <span class="token operator">+</span> registryURL<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Export dubbo service "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" to url "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token function">doExportUrl</span><span class="token punctuation">(</span>registryURL<span class="token punctuation">.</span><span class="token function">putAttribute</span><span class="token punctuation">(</span>EXPORT_KEY<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Export dubbo service "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" to url "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">doExportUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="16-7-1-doExportUrl方法"><a href="#16-7-1-doExportUrl方法" class="headerlink" title="16.7.1   doExportUrl方法"></a>16.7.1   doExportUrl方法</h3><p>与 16.6.1 doExportUrl方法 导出本地协议是一样的逻辑 ，我们来看看点不同地方 </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doExportUrl</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token keyword">boolean</span> withMetaData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>withMetaData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//远程服务导出逐个值为true 元数据invoker包装一下</span>
            invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocolSPI<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>与本地导出ProtocolFilterWrapper的不同之处<br> 服务发现service-discovery-registry的导出UrlUtils.isRegistry(invoker.getUrl() 判断结果为true会走这个逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
       <span class="token comment">//注册中心的协议导出直接执行</span>
       <span class="token comment">// 服务发现service-discovery-registry的导出会走这个逻辑</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//过滤器调用链FilterChainBuilder的扩展对象查询</span>
       <span class="token class-name">FilterChainBuilder</span> builder <span class="token operator">=</span> <span class="token function">getFilterChainBuilder</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//这里分为2步 生成过滤器调用链 然后使用链表中的节点调用  这里值查询provider类型的过滤器</span>
       <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> SERVICE_FILTER_KEY<span class="token punctuation">,</span> <span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>PROVIDER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>与 协议监听器Wrapper ProtocolListenerWrapper 的不同之处</p>
<p> 服务发现service-discovery-registry的导出UrlUtils.isRegistry(invoker.getUrl() 判断结果为true会走这个逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
       <span class="token comment">//注册中心地址则直接导出</span>
        <span class="token comment">// 服务发现service-discovery-registry的导出会走这个逻辑</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// 先导出对象 再创建过滤器包装对象 执行监听器逻辑</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ListenerExporterWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span><span class="token class-name">ScopeModelUtil</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ExporterListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EXPORTER_LISTENER_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>与 16.6.3.4 QOS的协议Wrapper QosProtocolWrapper 不同之处</p>
<p> 服务发现service-discovery-registry的导出UrlUtils.isRegistry(invoker.getUrl() 判断结果为true会走这个逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
         <span class="token comment">//注册中心导出的时候开启QOS 默认端口22222</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRegistry</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startQosServer</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>启动QOS服务startQosServer</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startQosServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasStarted<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> qosEnable <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>QOS_ENABLE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qosEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"qos won't be started because it is disabled. "</span> <span class="token operator">+</span>
                        <span class="token string">"Please check dubbo.application.qos.enable is configured either in system property, "</span> <span class="token operator">+</span>
                        <span class="token string">"dubbo.properties or XML/spring-boot configuration."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> host <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>QOS_HOST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> port <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>QOS_PORT<span class="token punctuation">,</span> <span class="token class-name">QosConstants</span><span class="token punctuation">.</span>DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> acceptForeignIp <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>ACCEPT_FOREIGN_IP<span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Server</span> server <span class="token operator">=</span> frameworkModel<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Server</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setAcceptForeignIp</span><span class="token punctuation">(</span>acceptForeignIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Fail to start qos server: "</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>QOS的Server的启动方法start</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//1个主线程</span>
        boss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">"qos-boss"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//0个从线程</span>
        worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">"qos-worker"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//服务端启动器，和参数设置</span>
        <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>boss<span class="token punctuation">,</span> worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>TCP_NODELAY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QosProcessHandler</span><span class="token punctuation">(</span>frameworkModel<span class="token punctuation">,</span> welcome<span class="token punctuation">,</span> acceptForeignIp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"qos-server bind localhost:"</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"qos-server can not bind localhost:"</span> <span class="token operator">+</span> port<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> throwable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>QOS处理器为QosProcessHandler关于QosProcessHandler的细节这里先不说</p>
<p>最后一个不同的地方调用链路走的这个 RegistryProtocol</p>
<h3 id="16-7-2-通过注册协议导出服务与注册服务的流程"><a href="#16-7-2-通过注册协议导出服务与注册服务的流程" class="headerlink" title="16.7.2 通过注册协议导出服务与注册服务的流程"></a>16.7.2 通过注册协议导出服务与注册服务的流程</h3><p>RegistryProtocol的导出方法：<br>这个方法非常重要也是服务注册的核心代码，先概括下包含了哪些步骤</p>
<ul>
<li>覆盖配置</li>
<li>导出协议端口开启TCP服务</li>
<li>注册到注册中心</li>
<li>通知服务启动了</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> originInvoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">//service-discovery-registry://8.131.79.126:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-api-provider&amp;dubbo=2.0.2&amp;pid=14256&amp;registry=zookeeper&amp;release=3.0.8&amp;timestamp=1653710477057</span>
       <span class="token class-name">URL</span> registryUrl <span class="token operator">=</span> <span class="token function">getRegistryUrl</span><span class="token punctuation">(</span>originInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// url to export locally</span>
       <span class="token comment">//dubbo://192.168.1.9:20880/link.elastic.dubbo.entity.DemoService?anyhost=true&amp;application=dubbo-demo-api-provider&amp;background=false&amp;bind.ip=192.168.1.9&amp;bind.port=20880&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=link.elastic.dubbo.entity.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=14256&amp;release=3.0.8&amp;service-name-mapping=true&amp;side=provider&amp;timestamp=1653710479073</span>
       <span class="token class-name">URL</span> providerUrl <span class="token operator">=</span> <span class="token function">getProviderUrl</span><span class="token punctuation">(</span>originInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// Subscribe the override data</span>
       <span class="token comment">// FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call</span>
       <span class="token comment">//  the same service. Because the subscribed is cached key with the name of the service, it causes the</span>
       <span class="token comment">//  subscription information to cover.</span>
       <span class="token comment">//provider://192.168.1.9:20880/link.elastic.dubbo.entity.DemoService?anyhost=true&amp;application=dubbo-demo-api-provider&amp;background=false&amp;bind.ip=192.168.1.9&amp;bind.port=20880&amp;category=configurators&amp;check=false&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=link.elastic.dubbo.entity.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=14256&amp;release=3.0.8&amp;service-name-mapping=true&amp;side=provider&amp;timestamp=1653710479073</span>
       
       <span class="token keyword">final</span> <span class="token class-name">URL</span> overrideSubscribeUrl <span class="token operator">=</span> <span class="token function">getSubscribedOverrideUrl</span><span class="token punctuation">(</span>providerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//override配置</span>
       <span class="token keyword">final</span> <span class="token class-name">OverrideListener</span> overrideSubscribeListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OverrideListener</span><span class="token punctuation">(</span>overrideSubscribeUrl<span class="token punctuation">,</span> originInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">,</span> <span class="token class-name">NotifyListener</span><span class="token punctuation">&gt;</span></span> overrideListeners <span class="token operator">=</span> <span class="token function">getProviderConfigurationListener</span><span class="token punctuation">(</span>providerUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOverrideListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       overrideListeners<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>registryUrl<span class="token punctuation">,</span> overrideSubscribeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

       providerUrl <span class="token operator">=</span> <span class="token function">overrideUrlWithConfig</span><span class="token punctuation">(</span>providerUrl<span class="token punctuation">,</span> overrideSubscribeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
       <span class="token comment">//export invoker</span>
       <span class="token keyword">final</span> <span class="token class-name">ExporterChangeableWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> <span class="token function">doLocalExport</span><span class="token punctuation">(</span>originInvoker<span class="token punctuation">,</span> providerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// url to registry</span>
       <span class="token comment">//通过URL获取 注册中心Registry操作对象</span>
       <span class="token keyword">final</span> <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span>registryUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//需要向注册中心注册地址转换</span>
       <span class="token comment">//dubbo://192.168.1.9:20880/link.elastic.dubbo.entity.DemoService?anyhost=true&amp;application=dubbo-demo-api-provider&amp;background=false&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=link.elastic.dubbo.entity.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=14656&amp;release=3.0.8&amp;service-name-mapping=true&amp;side=provider&amp;timestamp=1653711086189</span>
       <span class="token keyword">final</span> <span class="token class-name">URL</span> registeredProviderUrl <span class="token operator">=</span> <span class="token function">getUrlToRegistry</span><span class="token punctuation">(</span>providerUrl<span class="token punctuation">,</span> registryUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// decide if we need to delay publish (provider itself and registry should both need to register)</span>
       <span class="token keyword">boolean</span> register <span class="token operator">=</span> providerUrl<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REGISTER_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> registryUrl<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REGISTER_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//是否向注册中心注册</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">register</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> registeredProviderUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token comment">// register stated url on provider model</span>
       <span class="token function">registerStatedUrl</span><span class="token punctuation">(</span>registryUrl<span class="token punctuation">,</span> registeredProviderUrl<span class="token punctuation">,</span> register<span class="token punctuation">)</span><span class="token punctuation">;</span>


       exporter<span class="token punctuation">.</span><span class="token function">setRegisterUrl</span><span class="token punctuation">(</span>registeredProviderUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
       exporter<span class="token punctuation">.</span><span class="token function">setSubscribeUrl</span><span class="token punctuation">(</span>overrideSubscribeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">isServiceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// Deprecated! Subscribe to override rules in 2.6.x or before.</span>
           registry<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>overrideSubscribeUrl<span class="token punctuation">,</span> overrideSubscribeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	<span class="token comment">//内置监听器通知 这个不是通知消费者的</span>
       <span class="token function">notifyExport</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//Ensure that a new exporter instance is returned every time export</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DestroyableExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="16-8-doLocalExport本地导出协议开启端口"><a href="#16-8-doLocalExport本地导出协议开启端口" class="headerlink" title="16.8 doLocalExport本地导出协议开启端口"></a>16.8 doLocalExport本地导出协议开启端口</h2><p>前面已经看过了本地协议JVM协议的服务导出和注册中心配置的导出，这里可以直接看一些关键代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ExporterChangeableWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doLocalExport</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> originInvoker<span class="token punctuation">,</span> <span class="token class-name">URL</span> providerUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>originInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ExporterChangeableWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bounds<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invokerDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerDelegate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>originInvoker<span class="token punctuation">,</span> providerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//代码中用的这个protoco对象是dubbo自动生成的适配器对象protocol$Adaptive 适配器对象会根据当前协议的参数来查询具体的协议扩展对象</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExporterChangeableWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invokerDelegate<span class="token punctuation">)</span><span class="token punctuation">,</span> originInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面这个protocol$Adaptive 协议的export导出方法与之前的一样也会经历下面几个过程，具体细节可以参考JVM协议的导出：</p>
<ul>
<li>ProtocolSerializationWrapper</li>
<li>ProtocolFilterWrapper</li>
<li>ProtocolListenerWrapper</li>
<li>QosProtocolWrapper</li>
<li>唯一不同的是我们这里对应的协议扩展类型为DubboProtocol、<br>接下来来看下DubboProtocol的导出服务export方法实现：</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
       <span class="token function">checkDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//服务提供者的url参考例子dubbo://192.168.1.9:20880/link.elastic.dubbo.entity.DemoService?anyhost=true&amp;application=dubbo-demo-api-provider&amp;background=false&amp;bind.ip=192.168.1.9&amp;bind.port=20880&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;interface=link.elastic.dubbo.entity.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=6043&amp;release=3.0.8&amp;service-name-mapping=true&amp;side=provider&amp;timestamp=1654224285437</span>
       <span class="token class-name">URL</span> url <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// export service.</span>
       <span class="token comment">//生成服务的key参考：link.elastic.dubbo.entity.DemoService:20880</span>
       <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">serviceKey</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//创建导出服务用的导出器DubboExporter</span>
       <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> key<span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//export a stub service for dispatching event</span>
       <span class="token comment">//stub配置校验</span>
       <span class="token class-name">Boolean</span> isStubSupportEvent <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>STUB_EVENT_KEY<span class="token punctuation">,</span> DEFAULT_STUB_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Boolean</span> isCallbackservice <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>IS_CALLBACK_SERVICE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>isStubSupportEvent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isCallbackservice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">String</span> stubServiceMethods <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>STUB_EVENT_METHODS_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>stubServiceMethods <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> stubServiceMethods<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"consumer ["</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>INTERFACE_KEY<span class="token punctuation">)</span> <span class="token operator">+</span>
                           <span class="token string">"], has set stubproxy support event ,but no stub methods founded."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>

           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
	<span class="token comment">//创建服务开启服务端口</span>
       <span class="token function">openServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//</span>
       <span class="token function">optimizeSerialization</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> exporter<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="开启服务端口"><a href="#开启服务端口" class="headerlink" title="开启服务端口"></a>开启服务端口</h3><p>这里就到了RPC协议的TCP通信模块了，对应DubboProtocol 的    openServer(url);方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">openServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">checkDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// find server. 地址作为key这里是192.168.1.9:20880</span>
       <span class="token class-name">String</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// client can export a service which only for server to invoke</span>
       <span class="token comment">//默认提供者开启服务，消费者是不能开启服务的</span>
       <span class="token keyword">boolean</span> isServer <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>IS_SERVER_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//协议服务器 下面一个双重校验锁检查，如果为空则创建服务</span>
           <span class="token class-name">ProtocolServer</span> server <span class="token operator">=</span> serverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   server <span class="token operator">=</span> serverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       serverMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">createServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                       server<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// server supports reset, use together with override</span>
               server<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为当前地址创建协议服务对应方法如下：<br>DubboProtocol的createServer方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ProtocolServer</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		<span class="token comment">//下面将url增加了心跳参数最终如下dubbo://192.168.1.9:20880/link.elastic.dubbo.entity.DemoService?anyhost=true&amp;application=dubbo-demo-api-provider&amp;background=false&amp;bind.ip=192.168.1.9&amp;bind.port=20880&amp;channel.readonly.sent=true&amp;codec=dubbo&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;heartbeat=60000&amp;interface=link.elastic.dubbo.entity.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=6700&amp;release=3.0.8&amp;service-name-mapping=true&amp;side=provider&amp;timestamp=1654225251112</span>
        url <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token comment">// send readonly event when server closes, it's enabled by default</span>
                <span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>CHANNEL_READONLYEVENT_SENT_KEY<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// enable heartbeat by default</span>
                <span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>HEARTBEAT_KEY<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>DEFAULT_HEARTBEAT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span>CODEC_KEY<span class="token punctuation">,</span> <span class="token class-name">DubboCodec</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//这里服务端使用的网络库这里是默认值netty</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>SERVER_KEY<span class="token punctuation">,</span> DEFAULT_REMOTING_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">getOrDefaultFrameworkModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Transporter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasExtension</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"Unsupported server type: "</span> <span class="token operator">+</span> str <span class="token operator">+</span> <span class="token string">", url: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//dubbo交换器层对象创建</span>
        <span class="token class-name">ExchangeServer</span> server<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
        	<span class="token comment">//这个方法会绑定端口，关于交换器与传输网络层到后面统一说</span>
        	<span class="token comment">//这里通过绑定url和请求处理器来创建交换器对象</span>
            server <span class="token operator">=</span> <span class="token class-name">Exchangers</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"Fail to start server(url: "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">") "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        str <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>CLIENT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supportedTypes <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getOrDefaultFrameworkModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Transporter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSupportedExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportedTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"Unsupported client type: "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">DubboProtocolServer</span> protocolServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboProtocolServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭等待时长默认为10秒</span>
        <span class="token function">loadServerProperties</span><span class="token punctuation">(</span>protocolServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> protocolServer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="16-9-向注册中心注册服务register"><a href="#16-9-向注册中心注册服务register" class="headerlink" title="16.9 向注册中心注册服务register"></a>16.9 向注册中心注册服务register</h2><p> 这个细节在下个博客中说涉及到Dubbo3的双注册</p>
<p>查看更多原文,技术<strong>咨询</strong>与<strong>支持</strong>,可以扫描<strong>微信公众号</strong>进行回复咨询<br><img src="https://img-blog.csdnimg.cn/20210523134648783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbmdqdW55YW4=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>

			<br>
			
			
			<a class="tag-unordered list-link" href="/tags/Dubbo/" rel="tag">Dubbo<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3/" rel="tag">Dubbo3<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">Dubbo3源码解析<span class="tag-unordered list-count">23</span></a>

			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
        
    

    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                         <!-- 下一篇文章 --> 
                            <div class="new">
                                <span>下一章</span>
                                <a href="/2022/07/10/dubbo/17-dubbo3-ying-yong-ji-zhu-ce-zhi-fu-wu-ti-gong-zhe-de-shuang-zhu-ce-yuan-li/"> 17-【Dubbo3.0.8源码解析系列】Dubbo服务提供者的双注册原理</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2022/07/10/dubbo/15-dubbo-de-san-da-zhong-xin-zhi-yuan-shu-ju-zhong-xin-yuan-ma-jie-xi/"> 15-【Dubbo3.0.8源码解析系列】Dubbo的三大中心之元数据中心源码解析</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'OrwF9gExPcH3pyeb35WIuKun-9Nh9j0Va',
        appKey: 'W098QAVm3hxbnBWRpho3a6HN'
    })
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">中间件源码</div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                </div>
                <div calss="footer-copyright">&copy; 2022 中间件源码
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
