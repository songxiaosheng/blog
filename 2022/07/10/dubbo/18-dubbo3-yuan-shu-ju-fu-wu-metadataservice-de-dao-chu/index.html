<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		
<title>18-【Dubbo3.0.8源码解析系列】Dubbo3元数据服务MetadataService的导出 - 中间件源码</title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 6.2.0">
<link rel="stylesheet" href="/css/style.css?v=1662207200403">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1662207200403"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?2ee30baeebf59e698360da94012edd15';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="中间件源码" type="application/atom+xml">
</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="中间件源码">中间件源码</a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/index.html">首页</a></li>
            
                <li class="nav-item"><a href="/categories">分类</a></li>
            
                <li class="nav-item"><a href="/about.html">About</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>18-【Dubbo3.0.8源码解析系列】Dubbo3元数据服务MetadataService的导出</h1>
			<div class="info"><span class="date">2022年7月10日</span>•songxiaosheng 
			
					《<a class="nexmoefont icon-appstore-fill -link" href="/categories/Dubbo3%E6%BA%90%E7%A0%81/">Dubbo3源码</a>》
				
				<!-- 
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/dubbo/18-Dubbo3元数据服务MetadataService的导出.md" target="_blank" rel="external nofollow noreferrer noopener">编辑</a>
				 -->
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="18-Dubbo3元数据服务MetadataService的导出"><a href="#18-Dubbo3元数据服务MetadataService的导出" class="headerlink" title="18-Dubbo3元数据服务MetadataService的导出"></a>18-Dubbo3元数据服务MetadataService的导出</h1><h2 id="18-1-简介"><a href="#18-1-简介" class="headerlink" title="18.1 简介"></a>18.1 简介</h2><p>MetadataService<br>此服务用于公开Dubbo进程内的元数据信息。典型用途包括：</p>
<ul>
<li>使用者查询提供者的元数据信息，以列出接口和每个接口的配置</li>
<li>控制台（dubbo admin）查询特定进程的元数据，或聚合所有进程的数据。在Dubbo2.x的时候，所有的服务数据都是以接口的形式注册在注册中心.</li>
</ul>
<p>Dubbo3将部分数据抽象为元数据的形式来将数据存放在元数据中心，然后元数据由服务提供者提供给消费者而不是再由注册中心进行推送，如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/f7b3bc1f44f74859b2dfb419b9945d41.png" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/4d230ee194064cd09081e784736817df.png" alt="在这里插入图片描述"><br>引入 MetadataService 元数据服务服务的好处<br>• 由中心化推送转向点对点拉取（Consumer - Proroder）<br>• 易于扩展更多的参数<br>• 更多的数据量<br>• 对外暴露更多的治理数据</p>
<h2 id="18-2-MetadataService的导出过程"><a href="#18-2-MetadataService的导出过程" class="headerlink" title="18.2 MetadataService的导出过程"></a>18.2 MetadataService的导出过程</h2><p>了解元数据的到处过程，这个就要继续前面博客往后的代码了前面博客说了一个服务发布之后的服务信息的双注册数据，这里继续看下导出服务之后的代码：<br>先来简单回顾下模块发布的启动生命周期方法：</p>
<p>DefaultModuleDeployer类型的start方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Future</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

       <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token function">onModuleStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// initialize</span>
           applicationDeployer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// export services</span>
           <span class="token function">exportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// prepare application instance</span>
           <span class="token comment">// exclude internal module to avoid wait itself</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleModel <span class="token operator">!=</span> moduleModel<span class="token punctuation">.</span><span class="token function">getApplicationModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInternalModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               applicationDeployer<span class="token punctuation">.</span><span class="token function">prepareInternalModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

           <span class="token comment">// refer services</span>
           <span class="token function">referServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// if no async export/refer services, just set started</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncExportingFutures<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> asyncReferringFutures<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token function">onModuleStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">return</span> startFuture<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面的博客我们已经说了服务提供者导出服务的方法如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// export services</span>
<span class="token function">exportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在导出服务之后如果代码中配置了引用服务的代码将会执行引用服务的功能，调用代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">referServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>不过我们样例代码并没有介绍引用服务的功能，这里先不说，等服务提供者完全启动成功之后我们再来看消费者的逻辑。</p>
<p>接下来我们要看的是模块启动成功之后的方法 onModuleStarted();，在这个方法中会去发布服务元数据信息。</p>
<h2 id="18-3-模块启动成功时候的逻辑-onModuleStarted"><a href="#18-3-模块启动成功时候的逻辑-onModuleStarted" class="headerlink" title="18.3 模块启动成功时候的逻辑 onModuleStarted();"></a>18.3 模块启动成功时候的逻辑 onModuleStarted();</h2><p>这里我们直接先看代码再来分析下逻辑：</p>
<p>DefaultModuleDeployer类型的onModuleStarted方法如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onModuleStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
       	<span class="token comment">//状态判断是否为启动中如果是则将状态设置为STARTED</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">//先修改状态</span>
               <span class="token function">setStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" has started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">//状态修改成功之后开始通知应用程序发布器模块发布器启动成功了</span>
               applicationDeployer<span class="token punctuation">.</span><span class="token function">notifyModuleChanged</span><span class="token punctuation">(</span>moduleModel<span class="token punctuation">,</span> <span class="token class-name">DeployState</span><span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
           <span class="token comment">// complete module start future after application state changed</span>
           <span class="token function">completeStartFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>应用程序发布器处理启动成功的逻辑：<br>DefaultApplicationDeployer类型的notifyModuleChanged方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyModuleChanged</span><span class="token punctuation">(</span><span class="token class-name">ModuleModel</span> moduleModel<span class="token punctuation">,</span> <span class="token class-name">DeployState</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//根据所有模块的状态来判断应用发布器的状态</span>
       <span class="token function">checkState</span><span class="token punctuation">(</span>moduleModel<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// notify module state changed or module changed</span>
       <span class="token comment">//通知所有模块状态更新</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           stateLock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应用发布器模型DefaultApplicationDeployer检查状态方法checkState代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token class-name">ModuleModel</span> moduleModel<span class="token punctuation">,</span> <span class="token class-name">DeployState</span> moduleState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//存在写操作 先加个锁</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       	<span class="token comment">//非内部模块，并且模块的状态是发布成功了</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>moduleModel<span class="token punctuation">.</span><span class="token function">isInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> moduleState <span class="token operator">==</span> <span class="token class-name">DeployState</span><span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               
               <span class="token function">prepareApplicationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//应用下所有模块状态进行汇总计算</span>
           <span class="token class-name">DeployState</span> newState <span class="token operator">=</span> <span class="token function">calculateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">switch</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">case</span> STARTED<span class="token operator">:</span>
                   <span class="token function">onStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token keyword">case</span> STARTING<span class="token operator">:</span>
                   <span class="token function">onStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token keyword">case</span> STOPPING<span class="token operator">:</span>
                   <span class="token function">onStopping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token keyword">case</span> STOPPED<span class="token operator">:</span>
                   <span class="token function">onStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token keyword">case</span> FAILED<span class="token operator">:</span>
                   <span class="token class-name">Throwable</span> error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                   <span class="token class-name">ModuleModel</span> errorModule <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ModuleModel</span> <span class="token keyword">module</span> <span class="token operator">:</span> applicationModel<span class="token punctuation">.</span><span class="token function">getModuleModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token class-name">ModuleDeployer</span> deployer <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">getDeployer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token keyword">if</span> <span class="token punctuation">(</span>deployer<span class="token punctuation">.</span><span class="token function">isFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> deployer<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                           error <span class="token operator">=</span> deployer<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           errorModule <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
                           <span class="token keyword">break</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span>
                   <span class="token punctuation">}</span>
                   <span class="token function">onFailed</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" found failed module: "</span> <span class="token operator">+</span> errorModule<span class="token punctuation">.</span><span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token keyword">case</span> PENDING<span class="token operator">:</span>
                   <span class="token comment">// cannot change to pending from other state</span>
                   <span class="token comment">// setPending();</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="18-4-准备发布元数据信息和应用实例信息"><a href="#18-4-准备发布元数据信息和应用实例信息" class="headerlink" title="18.4 准备发布元数据信息和应用实例信息"></a>18.4 准备发布元数据信息和应用实例信息</h2><p>前面有个代码调用比较重要：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">prepareApplicationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>DefaultApplicationDeployer类型的prepareApplicationInstance方法如下所示</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepareApplicationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//已经注册过应用实例数据了 直接返回 （下面CAS逻辑判断了）</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPreparedApplicationInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	<span class="token comment">//注册开关控制默认为true</span>
	<span class="token comment">//通过将registerConsumer默认设置为“false”来关闭纯使用者进程实例的注册。</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRegisterConsumerInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">exportMetadataService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPreparedApplicationInstance<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// register the local ServiceInstance if required</span>
               <span class="token function">registerServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="18-4-1-导出元数据服务方法exportMetadataService"><a href="#18-4-1-导出元数据服务方法exportMetadataService" class="headerlink" title="18.4.1 导出元数据服务方法exportMetadataService"></a>18.4.1 导出元数据服务方法exportMetadataService</h3><p> 这里我们就先直接来贴一下代码：</p>
<p>DefaultApplicationDeployer类型的exportMetadataService方法如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportMetadataService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//这里监听器我们主要关注的类型是ExporterDeployListener类型</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeployListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationModel</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationDeployListener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 回调监听器的模块启动成功方法</span>
                   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationDeployListener</span><span class="token punctuation">)</span> listener<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onModuleStarted</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" an exception occurred when handle starting event"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面我们主要关注ExporterDeployListener类型的监听器的回调方法，这里我贴一下代码：<br>ExporterDeployListener类型的onModuleStarted方法如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onModuleStarted</span><span class="token punctuation">(</span><span class="token class-name">ApplicationModel</span> applicationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// start metadata service exporter</span>
     <span class="token comment">//MetadataServiceDelegation类型为实现提供远程RPC服务以方便元数据信息的查询功能的类型。</span>
       <span class="token class-name">MetadataServiceDelegation</span> metadataService <span class="token operator">=</span> applicationModel<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrRegisterBean</span><span class="token punctuation">(</span><span class="token class-name">MetadataServiceDelegation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataServiceExporter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           metadataServiceExporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurableMetadataServiceExporter</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">,</span> metadataService<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// fixme, let's disable local metadata service export at this moment</span>
           <span class="token comment">//默认我们是没有配置这个元数据类型的这里元数据类型默认为local 条件是不是remote则开始导出，在前面的博客&lt;&lt;Dubbo启动器DubboBootstrap添加应用程序的配置信息ApplicationConfig&gt;&gt; 中有提到这个配置下面我再说下</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>REMOTE_METADATA_STORAGE_TYPE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">getMetadataType</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               metadataServiceExporter<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在前面的博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/songjunyan/article/details/124524350">&lt;&lt;Dubbo启动器DubboBootstrap添加应用程序的配置信息ApplicationConfig&gt;&gt;</a> 中有提到这个配置下面我再说下</p>
<p>metadata-type</p>
<p>metadata 传递方式，是以 Provider 视角而言的，Consumer 侧配置无效，可选值有： </p>
<ul>
<li>remote - Provider 把 metadata 放到远端<strong>注册中心</strong>，Consumer 从<strong>注册中心获取</strong>。</li>
<li>local - Provider <strong>把 metadata 放在本地</strong>，<strong>Consumer 从 Provider 处直接获取</strong>  。</li>
</ul>
<p>可以看到默认的local配置元数据信息的获取是由消费者从提供者拉的，那提供者怎么拉取对应服务的元数据信息那就要要用到这个博客说到的MetadataService服务，传递方式为remote的方式其实就要依赖注册中心了相对来说增加了注册中心的压力。</p>
<h3 id="18-4-2-可配置元数据服务的导出ConfigurableMetadataServiceExporter的export"><a href="#18-4-2-可配置元数据服务的导出ConfigurableMetadataServiceExporter的export" class="headerlink" title="18.4.2 可配置元数据服务的导出ConfigurableMetadataServiceExporter的export"></a>18.4.2 可配置元数据服务的导出ConfigurableMetadataServiceExporter的export</h3><p>前面了解了导出服务的调用链路，这里详细看下ConfigurableMetadataServiceExporter的export过程源码如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">ConfigurableMetadataServiceExporter</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 		<span class="token comment">//元数据服务配置已经存在或者已经导出或者不可导出情况下是无需导出的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceConfig <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         	<span class="token comment">//创建服务配置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceConfig <span class="token operator">=</span> <span class="token function">buildServiceConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// export</span>
            <span class="token comment">//导出服务 ,导出服务的具体过程这里就不再说了可以看上一个博客，这个导出服务的过程会绑定端口</span>
            serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            metadataService<span class="token punctuation">.</span><span class="token function">setMetadataURL</span><span class="token punctuation">(</span>serviceConfig<span class="token punctuation">.</span><span class="token function">getExportedUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The MetadataService exports urls : "</span> <span class="token operator">+</span> serviceConfig<span class="token punctuation">.</span><span class="token function">getExportedUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The MetadataService has been exported : "</span> <span class="token operator">+</span> serviceConfig<span class="token punctuation">.</span><span class="token function">getExportedUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="18-4-3-元数据服务配置对象的创建"><a href="#18-4-3-元数据服务配置对象的创建" class="headerlink" title="18.4.3 元数据服务配置对象的创建"></a>18.4.3 元数据服务配置对象的创建</h3><p>前面我们看到了构建元数据服务对象的代码调用ServiceConfig<metadataservice>，接下来我们详细看下构建源码如下所示：<br>ConfigurableMetadataServiceExporter类型的buildServiceConfig构建元数据服务配置对象方法如下：</metadataservice></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataService</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildServiceConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//1 获取当前的应用配置 然后初始化应用配置</span>
       <span class="token class-name">ApplicationConfig</span> applicationConfig <span class="token operator">=</span> <span class="token function">getApplicationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//创建服务配置对象</span>
       <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataService</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//设置域模型</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">.</span><span class="token function">getInternalModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span>applicationConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//2 创建注册中心配置对象 然后并初始化</span>
       <span class="token class-name">RegistryConfig</span> registryConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">"N/A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       registryConfig<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">"internal-metadata-registry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3 创建服务配置对象，并初始化</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span>registryConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setRegister</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//4 生成协议配置 ，这里会配置一下元数据使用的服务端口号默认使用其他服务的端口20880</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token function">generateMetadataProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">MetadataService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//这里也是需要注意的地方服务引用的类型为MetadataServiceDelegation</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setRef</span><span class="token punctuation">(</span>metadataService<span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>applicationConfig<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token class-name">MetadataService</span><span class="token punctuation">.</span>VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//5 生成方法配置 这里目前提供的服务方法为getAndListenInstanceMetadata方法 后续可以看下这个方法的视线</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setMethods</span><span class="token punctuation">(</span><span class="token function">generateMethodConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setConnections</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// separate connection</span>
       serviceConfig<span class="token punctuation">.</span><span class="token function">setExecutes</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// max tasks running at the same time</span>

       <span class="token keyword">return</span> serviceConfig<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>这个服务配置对象的创建非常像我们第一个博客提到的服务配置过程，不过这个元数据服务对象有几个比较特殊的配置</p>
<ul>
<li>注册中心的配置register设置为了false 则为不向注册中心注册具体的服务配置信息</li>
<li>对每个提供者的最大连接数connections为1</li>
<li>服务提供者每服务每方法最大可并行执行请求数executes为100</li>
</ul>
<p>在使用过程中可以知道上面这几个配置值</p>
<h2 id="18-5-应用级数据注册-registerServiceInstance"><a href="#18-5-应用级数据注册-registerServiceInstance" class="headerlink" title="18.5 应用级数据注册   registerServiceInstance()"></a>18.5 应用级数据注册   registerServiceInstance()</h2><p>在前面导出元数据服务之后也会调用一行代码来注册应用级数据来保证应用上线</p>
<p>主要涉及到的代码为DefaultApplicationDeployer类型中的registerServiceInstance方法如下所示</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//标记变量设置为true</span>
           registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token class-name">ServiceInstanceMetadataUtils</span><span class="token punctuation">.</span><span class="token function">registerMetadataAndInstance</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Register instance error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// scheduled task for updating Metadata and ServiceInstance</span>
           asyncMetadataFuture <span class="token operator">=</span> frameworkExecutorRepository<span class="token punctuation">.</span><span class="token function">getSharedScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

               <span class="token comment">// ignore refresh metadata on stopping</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationModel<span class="token punctuation">.</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">try</span> <span class="token punctuation">{</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>applicationModel<span class="token punctuation">.</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token class-name">ServiceInstanceMetadataUtils</span><span class="token punctuation">.</span><span class="token function">refreshMetadataAndInstance</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>applicationModel<span class="token punctuation">.</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Refresh instance and metadata error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationUtils</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">,</span> METADATA_PUBLISH_DELAY_KEY<span class="token punctuation">,</span> DEFAULT_METADATA_PUBLISH_DELAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法先将应用元数据注册到注册中心，然后开始开启定时器每隔30秒同步一次元数据向注册中心。</p>
<h3 id="18-5-1-服务实例元数据工具类注册服务发现的元数据信息"><a href="#18-5-1-服务实例元数据工具类注册服务发现的元数据信息" class="headerlink" title="18.5.1 服务实例元数据工具类注册服务发现的元数据信息"></a>18.5.1 服务实例元数据工具类注册服务发现的元数据信息</h3><p>前面通过调用类型ServiceInstanceMetadataUtils工具类的registerMetadataAndInstance方法来进行服务实例数据和元数据的注册这里我们详细看下代码如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerMetadataAndInstance</span><span class="token punctuation">(</span><span class="token class-name">ApplicationModel</span> applicationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Start registering instance address to registry."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RegistryManager</span> registryManager <span class="token operator">=</span> applicationModel<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RegistryManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// register service instance</span>
<span class="token comment">//注意这里服务发现的类型只有ServiceDiscoveryRegistry类型的注册协议才满足        registryManager.getServiceDiscoveries().forEach(ServiceDiscovery::register);</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="18-5-2-AbstractServiceDiscovery中的服务发现数据注册的模版方法"><a href="#18-5-2-AbstractServiceDiscovery中的服务发现数据注册的模版方法" class="headerlink" title="18.5.2 AbstractServiceDiscovery中的服务发现数据注册的模版方法"></a>18.5.2 AbstractServiceDiscovery中的服务发现数据注册的模版方法</h3><p>AbstractServiceDiscovery类型的注册方法register()方法这个是一个模版方法，真正执行的注册逻辑封装在了doRegister方法中由扩展的服务发现子类来完成</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>
     <span class="token comment">//第一步创建应用的实例信息等待下面注册到注册中心</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstance <span class="token operator">=</span> <span class="token function">createServiceInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No valid instance found, stop registering instance address to registry."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

<span class="token comment">//是否需要更新</span>
      <span class="token keyword">boolean</span> revisionUpdated <span class="token operator">=</span> <span class="token function">calOrUpdateInstanceRevision</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>revisionUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reportMetadata</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//应用的实例信息注册到注册中心之上 ，这个</span>
          <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="18-5-3-应用级实例对象创建"><a href="#18-5-3-应用级实例对象创建" class="headerlink" title="18.5.3 应用级实例对象创建"></a>18.5.3 应用级实例对象创建</h3><p>可以看到在AbstractServiceDiscovery服务发现的第一步创建应用的实例信息等待下面注册到注册中心</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstance <span class="token operator">=</span> <span class="token function">createServiceInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最终创建的serviceInstance类型为ServiceInstance 这个是Dubbo封装的一个接口，具体实现类型为DefaultServiceInstance，我们可以看下应用级的元数据有哪些</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ServiceInstance</span> <span class="token function">createServiceInstance</span><span class="token punctuation">(</span><span class="token class-name">MetadataInfo</span> metadataInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//这里的服务名字为：dubbo-demo-api-provider</span>
    <span class="token class-name">DefaultServiceInstance</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultServiceInstance</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//应用服务的元数据 ，可以看下面debug的数据信息</span>
    instance<span class="token punctuation">.</span><span class="token function">setServiceMetadata</span><span class="token punctuation">(</span>metadataInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//metadataType的值为local 这个方法是将元数据类型存储到英勇的元数据对象中 对应内容为dubbo.metadata.storage-type:local</span>
    <span class="token function">setMetadataStorageType</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> metadataType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个是自定义元数据数据 我们也可以通过实现扩展ServiceInstanceCustomizer来自定义一些元数据</span>
    <span class="token class-name">ServiceInstanceMetadataUtils</span><span class="token punctuation">.</span><span class="token function">customizeInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个方法的主要目的就是将应用的元数据信息都封装到ServiceInstance类型中，不过额外提供了一个扩展性比较好的方法可以自定义元数据信息</p>
<p>前面的metadataInfo对象的信息如下图所示：<br><img src="https://img-blog.csdnimg.cn/d64c207637ed497786401e7af4a564e2.png" alt="在这里插入图片描述"></p>
<p>自定义元数据类型Dubbo官方提供了一个默认的实现类型为：ServiceInstanceMetadataCustomizer</p>
<p>最终封装好的元数据信息如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DefaultServiceInstance</span><span class="token punctuation">{</span>
serviceName<span class="token operator">=</span>'dubbo<span class="token operator">-</span>demo<span class="token operator">-</span>api<span class="token operator">-</span>provider'<span class="token punctuation">,</span> 
host<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.169</span>'<span class="token punctuation">,</span> 
port<span class="token operator">=</span><span class="token number">20880</span><span class="token punctuation">,</span> 
enabled<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> 
healthy<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span>
 metadata<span class="token operator">=</span><span class="token punctuation">{</span>
 	dubbo<span class="token punctuation">.</span>metadata<span class="token operator">-</span>service<span class="token punctuation">.</span>url<span class="token operator">-</span>params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"connections"</span><span class="token operator">:</span><span class="token string">"1"</span><span class="token punctuation">,</span>
 	<span class="token string">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
 	<span class="token string">"dubbo"</span><span class="token operator">:</span><span class="token string">"2.0.2"</span><span class="token punctuation">,</span>
 	<span class="token string">"release"</span><span class="token operator">:</span><span class="token string">"3.0.9"</span><span class="token punctuation">,</span>
 	<span class="token string">"side"</span><span class="token operator">:</span><span class="token string">"provider"</span><span class="token punctuation">,</span>
 	<span class="token string">"port"</span><span class="token operator">:</span><span class="token string">"20880"</span><span class="token punctuation">,</span>
 	<span class="token string">"protocol"</span><span class="token operator">:</span><span class="token string">"dubbo"</span>
 	<span class="token punctuation">}</span><span class="token punctuation">,</span> 
 	dubbo<span class="token punctuation">.</span>endpoints<span class="token operator">=</span><span class="token punctuation">[</span>
 	<span class="token punctuation">{</span><span class="token string">"port"</span><span class="token operator">:</span><span class="token number">20880</span><span class="token punctuation">,</span><span class="token string">"protocol"</span><span class="token operator">:</span><span class="token string">"dubbo"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
 	dubbo<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>storage<span class="token operator">-</span>type<span class="token operator">=</span>local<span class="token punctuation">,</span> 
 	timestamp<span class="token operator">=</span><span class="token number">1656227493387</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="18-5-4-应用级实例数据配置变更的的版本号获取"><a href="#18-5-4-应用级实例数据配置变更的的版本号获取" class="headerlink" title="18.5.4 应用级实例数据配置变更的的版本号获取"></a>18.5.4 应用级实例数据配置变更的的版本号获取</h3><p>前面创建元应用的实例信息后开始创建版本号来判断是否需要更新，对应AbstractServiceDiscovery类型的calOrUpdateInstanceRevision</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">calOrUpdateInstanceRevision</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//获取元数据版本号对应字段dubbo.metadata.revision</span>
      <span class="token class-name">String</span> existingInstanceRevision <span class="token operator">=</span> <span class="token function">getExportedServicesRevision</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//获取实例的服务元数据信息：metadata{app='dubbo-demo-api-provider',revision='null',size=1,services=[link.elastic.dubbo.entity.DemoService:dubbo]}</span>
      <span class="token class-name">MetadataInfo</span> metadataInfo <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getServiceMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//必须在不同线程之间同步计算此实例的状态，如同一实例的修订和修改。此方法的使用仅限于某些点，例如在注册期间。始终尝试使用此选项。改为getRevision（）。</span>
      <span class="token class-name">String</span> newRevision <span class="token operator">=</span> metadataInfo<span class="token punctuation">.</span><span class="token function">calAndGetRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//版本号发生了变更（元数据发生了变更）版本号是md5元数据信息计算出来HASH验证</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newRevision<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>existingInstanceRevision<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//版本号添加到dubbo.metadata.revision字段中</span>
          instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>EXPORTED_SERVICES_REVISION_PROPERTY_NAME<span class="token punctuation">,</span> metadataInfo<span class="token punctuation">.</span><span class="token function">getRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="18-5-4-1-元数据版本号的计算与HASH校验-calAndGetRevision"><a href="#18-5-4-1-元数据版本号的计算与HASH校验-calAndGetRevision" class="headerlink" title="18.5.4.1 元数据版本号的计算与HASH校验 calAndGetRevision"></a>18.5.4.1 元数据版本号的计算与HASH校验 calAndGetRevision</h4><p>这个方法其实比较重要，决定了什么时候会更新元数据，Dubbo使用了一种Hash验证的方式将元数据转MD5值与之前的存在的版本号（也是元数据转MD5得到的） 如果数据发生了变更则MD5值会发生变化 以此来更新元数据，不过发生了MD5冲突的话就会导致配置不更新这个冲突的概率非常小。<br>好了直接来看代码吧：<br>MetadataInfo类型的calAndGetRevision方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">calAndGetRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>revision <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>updated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> revision<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        updated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">//应用下没有服务则使用一个空的版本号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmptyMap</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>revision <span class="token operator">=</span> EMPTY_REVISION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//app是应用名</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDescString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> tempRevision <span class="token operator">=</span> <span class="token class-name">RevisionResolver</span><span class="token punctuation">.</span><span class="token function">calRevision</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEquals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>revision<span class="token punctuation">,</span> tempRevision<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//元数据重新注册的话我们可以看看这个日志metadata revision change</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"metadata revision changed: %s -&gt; %s, app: %s, services: %d"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>revision<span class="token punctuation">,</span> tempRevision<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>revision <span class="token operator">=</span> tempRevision<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rawMetadataInfo <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> revision<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>RevisionResolver类型的Md5运算计算版本号</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">md5Utils<span class="token punctuation">.</span><span class="token function">getMd5</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="18-5-5-reportMetadata"><a href="#18-5-5-reportMetadata" class="headerlink" title="18.5.5 reportMetadata"></a>18.5.5 reportMetadata</h3><p>回到18.5.2 AbstractServiceDiscovery中的模版方法register，这里我们来看下reportMetadata方法，不过这个方法目前并不会走到，因为我们默认的配置元数据是local不会直接把应用的元数据注册在元数据中心</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reportMetadata</span><span class="token punctuation">(</span><span class="token class-name">MetadataInfo</span> metadataInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//订阅元数据的标识符</span>
          <span class="token class-name">SubscriberMetadataIdentifier</span> identifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubscriberMetadataIdentifier</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> metadataInfo<span class="token punctuation">.</span><span class="token function">getRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//是否远程发布元数据，这里我们是本地注册这个就不会在元数据中心发布这个元数据信息</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DEFAULT_METADATA_STORAGE_TYPE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>metadataType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> metadataReport<span class="token punctuation">.</span><span class="token function">shouldReportMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> REMOTE_METADATA_STORAGE_TYPE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>metadataType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              metadataReport<span class="token punctuation">.</span><span class="token function">publishAppMetadata</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> metadataInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="18-5-6-扩展的注册中心来注册应用级服务发现数据doRegister方法"><a href="#18-5-6-扩展的注册中心来注册应用级服务发现数据doRegister方法" class="headerlink" title="18.5.6 扩展的注册中心来注册应用级服务发现数据doRegister方法"></a>18.5.6 扩展的注册中心来注册应用级服务发现数据doRegister方法</h3><p>前面我们说了AbstractServiceDiscovery中的模版方法register，在register会调用一个doRegister方法来注册应用级数据，这个方法是需要扩展注册中心的服务发现来自行实现的，我们这里以官方实现的Zookeeper服务发现模型为例:</p>
<p>ZookeeperServiceDiscovery中的doRegister方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> serviceInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">//Dubbo实现的ServiceInstance类型对象转 Curator的ServiceInstance</span>
           serviceDiscovery<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span><span class="token function">build</span><span class="token punctuation">(</span>serviceInstance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>REGISTRY_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"Failed register instance "</span> <span class="token operator">+</span> serviceInstance<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前面我们介绍了ZookeeperServiceDiscovery发现的构造器连接注册中心，这里来看下服务注册，<br>应用级实例数据注册一共分为两步<br>第一步是：Dubbo实现的ServiceInstance类型对象转 Curator的ServiceInstance<br>第二步是：执行registerService方法将数据注册到注册中心</p>
<p>先来看第一步：Dubbo实现的ServiceInstance类型对象转 Curator的ServiceInstance<br>关于Curator的服务发现原理可以参考官网的文章博客<a target="_blank" rel="noopener" href="https://curator.apache.org/curator-x-discovery/index.html">curator-x-discovery</a></p>
<p><strong>什么是发现服务？</strong><br>在 SOA/分布式系统中，服务需要找到彼此。即，Web 服务可能需要找到缓存服务等。DNS 可以用于此，但对于不断变化的服务来说，它远不够灵活。服务发现系统提供了一种机制：</p>
<ul>
<li>注册其可用性的服务</li>
<li>定位特定服务的单个实例</li>
<li>在服务实例更改时通知</li>
</ul>
<p>服务实例由类表示：ServiceInstance。ServiceInstances 具有名称、id、地址、端口和/或 ssl 端口，以及可选的有效负载（用户定义）。ServiceInstances 通过以下方式序列化并存储在 ZooKeeper 中：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">base path
       <span class="token operator">|</span>_______ service <span class="token class-name">A</span> name
                    <span class="token operator">|</span>__________ instance <span class="token number">1</span> id <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>serialized <span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>
                    <span class="token operator">|</span>__________ instance <span class="token number">2</span> id <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>serialized <span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>
                    <span class="token operator">|</span>__________ <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token operator">|</span>_______ service <span class="token class-name">B</span> name
                    <span class="token operator">|</span>__________ instance <span class="token number">1</span> id <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>serialized <span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>
                    <span class="token operator">|</span>__________ instance <span class="token number">2</span> id <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>serialized <span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>
                    <span class="token operator">|</span>__________ <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token operator">|</span>_______ <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个应用最终注册应用级服务数据如下：<br><img src="https://img-blog.csdnimg.cn/78ccb08965e140339bf528451d7b3c7c.png" alt="在这里插入图片描述"><br>这里需要注意的是这个 应用的IP+端口的服务元数据信息是临时节点<br>build方法内容对应着上图的JSON数据 可以看菜build方法封装的过程：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>x<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span>ServiceInstance</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZookeeperInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> serviceInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceInstanceBuilder</span> builder<span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> host <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getSortedMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token function">generateId</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ZookeeperInstance是Dubbo封装的用于存放payload数据 包含服务id，服务名字和元数据</span>
        <span class="token class-name">ZookeeperInstance</span> zookeeperInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperInstance</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            builder <span class="token operator">=</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span>zookeeperInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在《18.5 应用级数据注册   registerServiceInstance() 》 小节中介绍了应用元数据信息的注册调用代码，其实后面还有个update的逻辑定期30秒同步元数据到元数据中心，这里就不详细介绍了。</p>
<p>查看更多原文,技术<strong>咨询</strong>与<strong>支持</strong>,可以扫描<strong>微信公众号</strong>进行回复咨询<br><img src="https://img-blog.csdnimg.cn/20210523134648783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbmdqdW55YW4=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>

			<br>
			
			
			<a class="tag-unordered list-link" href="/tags/Dubbo/" rel="tag">Dubbo<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3/" rel="tag">Dubbo3<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">Dubbo3源码解析<span class="tag-unordered list-count">23</span></a>

			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
        
    

    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                         <!-- 下一篇文章 --> 
                            <div class="new">
                                <span>下一章</span>
                                <a href="/2022/07/10/dubbo/19-chong-xin-lai-guo-cong-yi-ge-fu-wu-xiao-fei-zhe-de-demo-shuo-qi/"> 19-【Dubbo3.0.8源码解析系列】重新来过从一个服务消费者的Demo说起</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2022/07/10/dubbo/17-dubbo3-ying-yong-ji-zhu-ce-zhi-fu-wu-ti-gong-zhe-de-shuang-zhu-ce-yuan-li/"> 17-【Dubbo3.0.8源码解析系列】Dubbo服务提供者的双注册原理</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'OrwF9gExPcH3pyeb35WIuKun-9Nh9j0Va',
        appKey: 'W098QAVm3hxbnBWRpho3a6HN'
    })
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">中间件源码</div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                </div>
                <div calss="footer-copyright">&copy; 2022 中间件源码
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
