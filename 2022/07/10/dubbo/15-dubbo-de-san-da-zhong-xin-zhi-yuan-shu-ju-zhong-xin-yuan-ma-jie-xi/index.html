<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		
<title>15-【Dubbo3.0.8源码解析系列】Dubbo的三大中心之元数据中心源码解析 - 中间件源码</title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 6.2.0">
<link rel="stylesheet" href="/css/style.css?v=1662518006033">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1662518006033"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?2ee30baeebf59e698360da94012edd15';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="中间件源码" type="application/atom+xml">
</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="中间件源码">中间件源码</a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/index.html">首页</a></li>
            
                <li class="nav-item"><a href="/categories">分类</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>15-【Dubbo3.0.8源码解析系列】Dubbo的三大中心之元数据中心源码解析</h1>
			<div class="info"><span class="date">2022年7月10日</span>•songxiaosheng 
			
					《<a class="nexmoefont icon-appstore-fill -link" href="/categories/Dubbo3%E6%BA%90%E7%A0%81/">Dubbo3源码</a>》
				
				<!-- 
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/dubbo/15-Dubbo的三大中心之元数据中心源码解析.md" target="_blank" rel="external nofollow noreferrer noopener">编辑</a>
				 -->
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="15-Dubbo的三大中心之元数据中心源码解析"><a href="#15-Dubbo的三大中心之元数据中心源码解析" class="headerlink" title="15-Dubbo的三大中心之元数据中心源码解析"></a>15-Dubbo的三大中心之元数据中心源码解析</h1><h2 id="15-1-简介"><a href="#15-1-简介" class="headerlink" title="15.1 简介"></a>15.1 简介</h2><p>关于元数据中心的概念对于大部分用户来说是比较陌生的,配置中心的话我们还好理解,对于元数据中心是什么,我们来看下我从官网拷贝过来的一段文字:</p>
<p>元数据中心在2.7.x版本开始支持，随着应用级别的服务注册和服务发现在Dubbo中落地，<strong>元数据中心也变的越来越重要</strong>。在以下几种情况下会需要部署元数据中心：</p>
<ul>
<li>对于一个原先采用老版本Dubbo搭建的应用服务，在迁移到Dubbo 3时，Dubbo 3 会需要一个<strong>元数据中心来维护RPC服务与应用的映射关系（即接口与应用的映射关系）</strong>，因为如果采用了<strong>应用级别的服务发现和服务注册</strong>，在注册中心中将<strong>采用“应用 —— 实例列表”结构</strong>的数据组织形式，<strong>不再是以往的“接口 —— 实例列表”结构的数据组织形式</strong>，而以往用接口级别的服务注册和服务发现的应用服务在<strong>迁移到应用级别</strong>时，<strong>得不到接口与应用之间的对应关系</strong>，从而无法从注册中心得到实例列表信息，所以<strong>Dubbo为了兼容这种场景，在Provider端启动时，会往元数据中心存储接口与应用的映射关系</strong>。</li>
<li>为了让<strong>注册中心更加聚焦与地址的发现和推送能力</strong>，<strong>减轻注册中心的负担</strong>，元数据中心承载了所有的服务元数据、大量接口/方法级别配置信息等，无论是接口粒度还是应用粒度的服务发现和注册，元数据中心都起到了重要的作用。</li>
<li>如果有以上两种需求，都可以选择部署元数据中心，并通过Dubbo的配置来集成该元数据中心。</li>
</ul>
<p><strong>元数据中心并不依赖于注册中心和配置中心</strong>，用户可以自由选择是否集成和部署元数据中心，如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/b42ea458a7c54b1fa1f9a65e6d946ed5.png" alt="//imgs/v3/concepts/centers-metadata.png"></p>
<p>该图中不配备配置中心，意味着可以不需要全局管理配置的能力。该图中不配备注册中心，意味着可能采用了Dubbo mesh的方案，也可能不需要进行服务注册，仅仅接收直连模式的服务调用。<br>官网参考文章地址:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v3.0/concepts/registry-configcenter-metadata/">部署架构（注册中心 配置中心 元数据中心</a></li>
<li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/references/metadata/">元数据参考手册</a></li>
</ul>
<p>综上所述可以用几句话概括下:</p>
<ul>
<li>元数据中心来维护RPC服务与应用的映射关系（即接口与应用的映射关系）来兼容接口与应用之间的对应关系</li>
<li>让注册中心更加聚焦与地址的发现和推送能力</li>
</ul>
<p>注册中心的启动是在DefaultApplicationDeployer中的初始化方法 initialize() 中:如下所示</p>
<p>这里只看下 startMetadataCenter();方法即可</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Ensure that the initialization is completed when concurrent calls</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>startLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// register shutdown hook</span>
           <span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token function">startConfigCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token function">loadApplicationConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token function">initModuleDeployers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// @since 2.7.8</span>
           <span class="token function">startMetadataCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

           <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" has been initialized!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="15-2-深入探究元数据中心的启动过程"><a href="#15-2-深入探究元数据中心的启动过程" class="headerlink" title="15.2 深入探究元数据中心的启动过程"></a>15.2 深入探究元数据中心的启动过程</h2><h3 id="15-2-1-启动元数据中心的代码全貌"><a href="#15-2-1-启动元数据中心的代码全貌" class="headerlink" title="15.2.1 启动元数据中心的代码全貌"></a>15.2.1 启动元数据中心的代码全貌</h3><p>关于元数据中心我们看下 startMetadataCenter()方法来大致了解下整个流程</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startMetadataCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//如果未配置元数据中心的地址等配置则使用注册中心的地址等配置做为元数据中心的配置</span>
        <span class="token function">useRegistryAsMetadataCenterIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//获取应用的配置信息</span>
        <span class="token class-name">ApplicationConfig</span> applicationConfig <span class="token operator">=</span> <span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//元数据配置类型 元数据类型， local 或 remote,，如果选择远程，则需要进一步指定元数据中心</span>
        <span class="token class-name">String</span> metadataType <span class="token operator">=</span> applicationConfig<span class="token punctuation">.</span><span class="token function">getMetadataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// FIXME, multiple metadata config support.</span>
        <span class="token comment">//查询元数据中心的地址等配置</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> metadataReportConfigs <span class="token operator">=</span> configManager<span class="token punctuation">.</span><span class="token function">getMetadataConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>metadataReportConfigs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这个就是判断 如果选择远程，则需要进一步指定元数据中心 否则就抛出来异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>REMOTE_METADATA_STORAGE_TYPE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>metadataType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No MetadataConfig found, Metadata Center address is required when 'metadata=remote' is enabled."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//MetadataReport实例的存储库对象获取</span>
        <span class="token class-name">MetadataReportInstance</span> metadataReportInstance <span class="token operator">=</span> applicationModel<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MetadataReportInstance</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> validMetadataReportConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>metadataReportConfigs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span> metadataReportConfig <span class="token operator">:</span> metadataReportConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConfigValidationUtils</span><span class="token punctuation">.</span><span class="token function">validateMetadataConfig</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            validMetadataReportConfigs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//初始化元数据</span>
        metadataReportInstance<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>validMetadataReportConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//MetadataReport实例的存储库对象初始化失败则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadataReportInstance<span class="token punctuation">.</span><span class="token function">inited</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s MetadataConfigs found, but none of them is valid."</span><span class="token punctuation">,</span> metadataReportConfigs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="15-2-2-元数据中心未配置则使用注册中心配置"><a href="#15-2-2-元数据中心未配置则使用注册中心配置" class="headerlink" title="15.2.2 元数据中心未配置则使用注册中心配置"></a>15.2.2 元数据中心未配置则使用注册中心配置</h3><p>前面在说配置中心的时候有说过配置中心如果未配置会使用注册中心的地址等信息作为默认配置,这里元数据做了类似的操作:如代码:<br>DefaultApplicationDeployer类型的 useRegistryAsMetadataCenterIfNecessary()方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">useRegistryAsMetadataCenterIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//配置缓存中查询元数据配置</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> metadataConfigs <span class="token operator">=</span> configManager<span class="token punctuation">.</span><span class="token function">getMetadataConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//配置存在则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>metadataConfigs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">////查询是否有注册中心设置了默认配置isDefault 设置为true的注册中心则为默认注册中心列表,如果没有注册中心设置为默认注册中心,则获取所有未设置默认配置的注册中心列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegistryConfig</span><span class="token punctuation">&gt;</span></span> defaultRegistries <span class="token operator">=</span> configManager<span class="token punctuation">.</span><span class="token function">getDefaultRegistries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultRegistries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//多注册中心遍历</span>
            defaultRegistries
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//筛选符合条件的注册中心 (筛选逻辑就是查看是否有对应协议的扩展支持)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isUsedRegistryAsMetadataCenter</span><span class="token punctuation">)</span>
                <span class="token comment">//注册中心配置映射为元数据中心  映射就是获取需要的配置</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">registryAsMetadataCenter</span><span class="token punctuation">)</span>
                <span class="token comment">//将元数据中心配置存储在配置缓存中方便后续使用</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>metadataReportConfig <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
              
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> metadataReportConfigs <span class="token operator">=</span> configManager<span class="token punctuation">.</span><span class="token function">getMetadataConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>metadataReportConfigs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span> existedConfig <span class="token operator">:</span> metadataReportConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>existedConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> existedConfig<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        configManager<span class="token punctuation">.</span><span class="token function">addMetadataReport</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> configOptional <span class="token operator">=</span> configManager<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> metadataReportConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>configOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        configManager<span class="token punctuation">.</span><span class="token function">addMetadataReport</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"use registry as metadata-center: "</span> <span class="token operator">+</span> metadataReportConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个代码有些细节就不细说了 我们概括下顺序梳理下思路:</p>
<ul>
<li>配置缓存中查询元数据配置,配置存在则直接返回</li>
<li>查询所有可用的默认注册中心列表<ul>
<li>多注册中心遍历</li>
<li>选符合条件的注册中心 (筛选逻辑就是查看是否有对应协议的扩展支持)</li>
<li>注册中心配置RegistryConfig映射转换为元数据中心配置类型MetadataReportConfig  映射就是获取需要的配置</li>
<li>将元数据中心配置存储在配置缓存中方便后续使用</li>
</ul>
</li>
</ul>
<p> 元数据的配置可以参考官网:<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v3.0/references/metadata/">元数据参考手册</a></p>
<p> 这里主要看下可配置项有哪些 对应类型为MetadataReportConfig 在官网暂时未找到合适的文档,这里整理下属性列表方便后续配置说明查看:</p>
<table>
<thead>
<tr>
<th>配置变量</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>String</td>
<td>配置id</td>
</tr>
<tr>
<td>protocol</td>
<td>String</td>
<td>元数据协议</td>
</tr>
<tr>
<td>address</td>
<td>String</td>
<td>元数据中心地址</td>
</tr>
<tr>
<td>port</td>
<td>Integer</td>
<td>元数据中心端口</td>
</tr>
<tr>
<td>username</td>
<td>String</td>
<td>元数据中心认证用户名</td>
</tr>
<tr>
<td>password</td>
<td>String</td>
<td>元数据中心认证密码</td>
</tr>
<tr>
<td>timeout</td>
<td>Integer</td>
<td>元数据中心的请求超时（毫秒）</td>
</tr>
<tr>
<td>group</td>
<td>String</td>
<td>该组将元数据保存在中。它与注册表相同</td>
</tr>
<tr>
<td>parameters</td>
<td>Map&lt;String, String&gt;</td>
<td>自定义参数</td>
</tr>
<tr>
<td>retryTimes</td>
<td>Integer</td>
<td>重试次数</td>
</tr>
<tr>
<td>retryPeriod</td>
<td>Integer</td>
<td>重试间隔</td>
</tr>
<tr>
<td>cycleReport</td>
<td>Boolean</td>
<td>默认情况下， 是否每天重复存储完整的元数据</td>
</tr>
<tr>
<td>syncReport</td>
<td>Boolean</td>
<td>Sync or Async report.</td>
</tr>
<tr>
<td>cluster</td>
<td>Boolean</td>
<td>需要群集支持，默认为false</td>
</tr>
<tr>
<td>registry</td>
<td>String</td>
<td>注册表配置id</td>
</tr>
<tr>
<td>file</td>
<td>String</td>
<td>元数据报告文件存储位置</td>
</tr>
<tr>
<td>check</td>
<td>Boolean</td>
<td>连接到元数据中心时要应用的失败策略</td>
</tr>
</tbody></table>
<h3 id="15-2-3-元数据中心的初始化逻辑"><a href="#15-2-3-元数据中心的初始化逻辑" class="headerlink" title="15.2.3 元数据中心的初始化逻辑"></a>15.2.3 元数据中心的初始化逻辑</h3><h4 id="15-2-3-1-元数据中心的初始化调用逻辑"><a href="#15-2-3-1-元数据中心的初始化调用逻辑" class="headerlink" title="15.2.3.1 元数据中心的初始化调用逻辑"></a>15.2.3.1 元数据中心的初始化调用逻辑</h4><p>主要看这一行比较重要的逻辑:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//初始化元数据</span>
metadataReportInstance<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>validMetadataReportConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在了解这一行逻辑之前我们先来看下元数据相关联的类型:</p>
<p>MetadataReportInstance中的初始化方法init</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">&gt;</span></span> metadataReportConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//CAS判断是否有初始化过</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>init<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	<span class="token comment">//元数据类型配置如果未配置则默认为local </span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>metadataType <span class="token operator">=</span> applicationModel<span class="token punctuation">.</span><span class="token function">getApplicationConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationOrElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>metadataType <span class="token operator">=</span> DEFAULT_METADATA_STORAGE_TYPE<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	<span class="token comment">//获取MetadataReportFactory 工厂类型</span>
       <span class="token class-name">MetadataReportFactory</span> metadataReportFactory <span class="token operator">=</span> applicationModel<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">MetadataReportFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token comment">//多元数据中心初始化</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span> metadataReportConfig <span class="token operator">:</span> metadataReportConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">init</span><span class="token punctuation">(</span>metadataReportConfig<span class="token punctuation">,</span> metadataReportFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span> config<span class="token punctuation">,</span> <span class="token class-name">MetadataReportFactory</span> metadataReportFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//配置转url</span>
       <span class="token class-name">URL</span> url <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">toUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>METADATA_REPORT_KEY<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">String</span> protocol <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>METADATA_REPORT_KEY<span class="token punctuation">,</span> DEFAULT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
           url <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">removeParameter</span><span class="token punctuation">(</span>METADATA_REPORT_KEY<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>APPLICATION_KEY<span class="token punctuation">,</span> applicationModel<span class="token punctuation">.</span><span class="token function">getCurrentConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> relatedRegistryId <span class="token operator">=</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> DEFAULT_KEY <span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//从元数据工厂中获取元数据</span>
       <span class="token class-name">MetadataReport</span> metadataReport <span class="token operator">=</span> metadataReportFactory<span class="token punctuation">.</span><span class="token function">getMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//缓存元数据到内存</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           metadataReports<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>relatedRegistryId<span class="token punctuation">,</span> metadataReport<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>关于元数据的初始化我们主要看两个位置:</p>
<ul>
<li>一个是元数据工厂对象的创建与初始化MetadataReportFactory</li>
<li>一个是元数据对象的创建与初始化MetadataReport</li>
</ul>
<h4 id="15-2-3-2-元数据工厂对象MetadataReportFactory"><a href="#15-2-3-2-元数据工厂对象MetadataReportFactory" class="headerlink" title="15.2.3.2 元数据工厂对象MetadataReportFactory"></a>15.2.3.2 元数据工厂对象MetadataReportFactory</h4><p>关于元数据工厂类型MetadataReportFactory,元数据工厂 用于<strong>创建与管理元数据对象</strong>, 相关类型如下:<br><img src="https://img-blog.csdnimg.cn/1e5ad28bbb544f0eba741218518ca4e2.png" alt="在这里插入图片描述"></p>
<p>我们这里主要以为Zookeeper扩展的元数据工厂ZookeeperMetadataReportFactory类型为例子:<br>实现类型逻辑不复杂,这里就直接贴代码看看:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperMetadataReportFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMetadataReportFactory</span> <span class="token punctuation">{</span>
	<span class="token comment">//与Zookeeper交互的传输器</span>
    <span class="token keyword">private</span> <span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">;</span>
	<span class="token comment">//应用程序模型</span>
    <span class="token keyword">private</span> <span class="token class-name">ApplicationModel</span> applicationModel<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ZookeeperMetadataReportFactory</span><span class="token punctuation">(</span><span class="token class-name">ApplicationModel</span> applicationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationModel <span class="token operator">=</span> applicationModel<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeperTransporter <span class="token operator">=</span> <span class="token class-name">ZookeeperTransporter</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DisableInject</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setZookeeperTransporter</span><span class="token punctuation">(</span><span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeperTransporter <span class="token operator">=</span> zookeeperTransporter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MetadataReport</span> <span class="token function">createMetadataReport</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> zookeeperTransporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>元数据工厂的实现比较简单 </p>
<ul>
<li>继承抽象的元数据工厂AbstractMetadataReportFactory</li>
<li>实现工厂方法createMetadataReport来创建一个元数据操作类型</li>
</ul>
<p>如果我们想要实现一个元数据工厂扩展可以参考Zookeeper的这个方式</p>
<h4 id="15-2-3-3-元数据操作对象MetadataReport的创建与初始化"><a href="#15-2-3-3-元数据操作对象MetadataReport的创建与初始化" class="headerlink" title="15.2.3.3 元数据操作对象MetadataReport的创建与初始化"></a>15.2.3.3 元数据操作对象MetadataReport的创建与初始化</h4><p>前面的从元数据工厂中获取元数据操作对象的逻辑处理代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//从元数据工厂中获取元数据 ,url对象可以理解为配置</span>
 <span class="token class-name">MetadataReport</span> metadataReport <span class="token operator">=</span> metadataReportFactory<span class="token punctuation">.</span><span class="token function">getMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>关于元数据对象,用于元数据信息的增删改查等逻辑的操作与元数据信息的缓存</p>
<p><img src="https://img-blog.csdnimg.cn/9b796c9369e34924af30a045fc537aa4.png" alt="在这里插入图片描述"></p>
<p>我们这里还是以Zookeeper的实现ZookeeperMetadataReportFactory类型做为参考:</p>
<p>我们先来看这个逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//从元数据工厂中获取元数据 ,url对象可以理解为配置</span>
 <span class="token class-name">MetadataReport</span> metadataReport <span class="token operator">=</span> metadataReportFactory<span class="token punctuation">.</span><span class="token function">getMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ZookeeperMetadataReportFactory的父类型AbstractMetadataReportFactory中的getMetadataReport方法如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">MetadataReport</span> <span class="token function">getMetadataReport</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//url值参考例子zookeeper://127.0.0.1:2181?application=dubbo-demo-api-provider&amp;client=&amp;port=2181&amp;protocol=zookeeper</span>
   		<span class="token comment">//如果存在export则移除</span>
       url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token class-name">MetadataReport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">removeParameters</span><span class="token punctuation">(</span>EXPORT_KEY<span class="token punctuation">,</span> REFER_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//生成元数据缓存key 元数据维度 地址+名字 </span>
          <span class="token comment">//如: zookeeper://127.0.0.1:2181/org.apache.dubbo.metadata.report.MetadataReport</span>
       <span class="token class-name">String</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toServiceString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//缓存中查询 查到则直接返回</span>
       <span class="token class-name">MetadataReport</span> metadataReport <span class="token operator">=</span> serviceStoreMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> metadataReport<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token comment">// Lock the metadata access process to ensure a single instance of the metadata instance</span>
       <span class="token comment">//存在写操作 加个锁</span>
       lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
       	<span class="token comment">//双重校验锁在查一下</span>
           metadataReport <span class="token operator">=</span> serviceStoreMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span> metadataReport<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//check参数 查元数据报错是否抛出异常</span>
           <span class="token keyword">boolean</span> check <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>CHECK_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>		
           <span class="token keyword">try</span> <span class="token punctuation">{</span>
           	<span class="token comment">//关键模版方法 调用扩展实现的具体业务(创建元数据操作对象)</span>
               metadataReport <span class="token operator">=</span> <span class="token function">createMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The metadata reporter failed to initialize"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                   <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
	<span class="token comment">//check逻辑检查</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">&amp;&amp;</span> metadataReport <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Can not create metadata Report "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//缓存对象 </span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataReport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               serviceStoreMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> metadataReport<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//返回</span>
           <span class="token keyword">return</span> metadataReport<span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
           <span class="token comment">// Release the lock</span>
           lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面这个抽象类AbstractMetadataReportFactory中的获取元数据操作对象的模版方法getMetadataReport(URL url), 用了双重校验锁的逻辑来创建对象缓存对象,又用了模版方法设计模式,来让抽象类做通用的逻辑,让实现类型去做扩展, 虽然代码写的太长了些整体还是用了不少的设计思想.</p>
<p>我们直接看这个代码:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">metadataReport <span class="token operator">=</span> <span class="token function">createMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个创建元数据操作对象的代码实际上走的是实现类型的逻辑:</p>
<p>来自工厂Bean ZookeeperMetadataReportFactory的工厂方法如下所示:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MetadataReport</span> <span class="token function">createMetadataReport</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperMetadataReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> zookeeperTransporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建了元数据操作对象,这里我们继续看下元数据操作对象ZookeeperMetadataReport创建做了哪些逻辑:<br>来自ZookeeperMetadataReport的构造器:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ZookeeperMetadataReport</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url即配置 配置传递给抽象类 做一些公共的逻辑</span>
		<span class="token comment">//url参考:zookeeper://127.0.0.1:2181/org.apache.dubbo.metadata.report.MetadataReport?application=dubbo-demo-api-provider&amp;client=&amp;port=2181&amp;protocol=zookeeper</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">isAnyHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"registry address == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> group <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span>DEFAULT_ROOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>group<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>PATH_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            group <span class="token operator">=</span> PATH_SEPARATOR <span class="token operator">+</span> group<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> group<span class="token punctuation">;</span>
        <span class="token comment">//连接Zookeeper</span>
        zkClient <span class="token operator">=</span> zookeeperTransporter<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>核心的公共的操作逻辑封装在父类AbstractMetadataReport里面<br>我们来看前面super调用的构造器逻辑:<br>如下所示:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">AbstractMetadataReport</span><span class="token punctuation">(</span><span class="token class-name">URL</span> reportServerURL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//设置url 如:zookeeper://127.0.0.1:2181/org.apache.dubbo.metadata.report.MetadataReport?application=dubbo-demo-api-provider&amp;client=&amp;port=2181&amp;protocol=zookeeper</span>
       <span class="token function">setUrl</span><span class="token punctuation">(</span>reportServerURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Start file save timer</span>
       <span class="token comment">//缓存的文件名字</span>
       <span class="token comment">//格式为: 用户目录+/.dubbo/dubbo-metadata- + 应用程序名字application + url地址(IP+端口) + 后缀.cache 如下所示</span>
       <span class="token comment">///Users/song/.dubbo/dubbo-metadata-dubbo-demo-api-provider-127.0.0.1-2181.cache</span>
       <span class="token class-name">String</span> defaultFilename <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>USER_HOME<span class="token punctuation">)</span> <span class="token operator">+</span> DUBBO_METADATA <span class="token operator">+</span>
           reportServerURL<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span>
           <span class="token function">replace</span><span class="token punctuation">(</span>reportServerURL<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span> <span class="token operator">+</span> CACHE<span class="token punctuation">;</span>
           <span class="token comment">//如果用户配置了缓存文件名字则以用户配置为准file</span>
       <span class="token class-name">String</span> filename <span class="token operator">=</span> reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>FILE_KEY<span class="token punctuation">,</span> defaultFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">//文件名字不为空</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//文件和父目录不存在则创建文件目录</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Invalid service store file "</span> <span class="token operator">+</span> file <span class="token operator">+</span> <span class="token string">", cause: Failed to create directory "</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// if this file exists, firstly delete it.</span>
           <span class="token comment">//还未初始化则已存在的历史文件删除掉</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//赋值给成员变量后续继续可以用</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
       <span class="token comment">//文件存在则直接加载文件中的内容</span>
       <span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//sync-report配置的值为同步配置还异步配置,true是同步配置,默认为false为异步配置</span>
       syncReport <span class="token operator">=</span> reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>SYNC_REPORT_KEY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//重试属性与逻辑也封装了一个类型 创建对象</span>
       <span class="token comment">//retry-times重试次数配置 默认为100次</span>
       <span class="token comment">//retry-period 重试间隔配置 默认为3000</span>
       metadataReportRetry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetadataReportRetry</span><span class="token punctuation">(</span>reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>RETRY_TIMES_KEY<span class="token punctuation">,</span> DEFAULT_METADATA_REPORT_RETRY_TIMES<span class="token punctuation">)</span><span class="token punctuation">,</span>
           reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>RETRY_PERIOD_KEY<span class="token punctuation">,</span> DEFAULT_METADATA_REPORT_RETRY_PERIOD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
       <span class="token comment">// cycle report the data switch</span>
       <span class="token comment">//是否定期从元数据中心同步配置</span>
       <span class="token comment">//cycle-report配置默认为true</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>CYCLE_REPORT_KEY<span class="token punctuation">,</span> DEFAULT_METADATA_REPORT_CYCLE_REPORT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//开启重试定时器 24个小时间隔从元数据中心同步一次</span>
           reportTimerScheduler <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"DubboMetadataReportTimer"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           reportTimerScheduler<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">publishAll</span><span class="token punctuation">,</span> <span class="token function">calculateStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ONE_DAY_IN_MILLISECONDS<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	
       <span class="token keyword">this</span><span class="token punctuation">.</span>reportMetadata <span class="token operator">=</span> reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REPORT_METADATA_KEY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>reportDefinition <span class="token operator">=</span> reportServerURL<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>REPORT_DEFINITION_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="15-2-3-4-内存中元数据自动同步到Zookeeper和本地文件"><a href="#15-2-3-4-内存中元数据自动同步到Zookeeper和本地文件" class="headerlink" title="15.2.3.4 内存中元数据自动同步到Zookeeper和本地文件"></a>15.2.3.4 内存中元数据自动同步到Zookeeper和本地文件</h4><p>这里来总结下元数据操作的初始化逻辑:</p>
<ul>
<li>首次初始化清理历史元数据文件如:<br>Users/song/.dubbo/dubbo-metadata-dubbo-demo-api-provider-127.0.0.1-2181.cache</li>
<li>如果非首次进来则直接加载缓存在本地的缓存文件,赋值给properties成员变量</li>
<li>初始化同步配置是否异步(默认为false), sync-report配置的值为同步配置还异步配置,true是同步配置,默认为false为异步配置</li>
<li>初始化重试属性</li>
<li>是否定期从元数据中心同步配置初始化 默认为true 24小时自动同步一次</li>
</ul>
<p>关于元数据同步可以看AbstractMetadataReport类型的publishAll方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">reportTimerScheduler <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"DubboMetadataReportTimer"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reportTimerScheduler<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">publishAll</span><span class="token punctuation">,</span> <span class="token function">calculateStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ONE_DAY_IN_MILLISECONDS<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里有个方法叫做calculateStartTime 这个代码是随机时间的between 2:00 am to 6:00 am, the time is random.  2点到6点之间启动, 低峰期启动自动同步<br>返回值:</p>
<p>AbstractMetadataReport类型的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">publishAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"start to publish all metadata."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doHandleMetadataCollection</span><span class="token punctuation">(</span>allMetadataReports<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>AbstractMetadataReport类型的doHandleMetadataCollection</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">doHandleMetadataCollection</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataIdentifier</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> metadataMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">MetadataIdentifier</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterable <span class="token operator">=</span> metadataMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterable<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetadataIdentifier</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> item <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PROVIDER_SIDE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            	<span class="token comment">//提供端的元数据则存储提供端元数据</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeProviderMetadata</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">FullServiceDefinition</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CONSUMER_SIDE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//消费端的元数据则存储提供端元数据</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeConsumerMetadata</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>提供端元数据的存储:<br>AbstractMetadataReport类型的storeProviderMetadata</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">storeProviderMetadata</span><span class="token punctuation">(</span><span class="token class-name">MetadataIdentifier</span> providerMetadataIdentifier<span class="token punctuation">,</span> <span class="token class-name">ServiceDefinition</span> serviceDefinition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>syncReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">storeProviderMetadataTask</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           reportCacheExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">storeProviderMetadataTask</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>AbstractMetadataReport类型的storeProviderMetadataTask<br>具体同步代码:storeProviderMetadataTask</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">storeProviderMetadataTask</span><span class="token punctuation">(</span><span class="token class-name">MetadataIdentifier</span> providerMetadataIdentifier<span class="token punctuation">,</span> <span class="token class-name">ServiceDefinition</span> serviceDefinition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"store provider metadata. Identifier : "</span> <span class="token operator">+</span> providerMetadataIdentifier <span class="token operator">+</span> <span class="token string">"; definition: "</span> <span class="token operator">+</span> serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            allMetadataReports<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            failedReports<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> data <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">//内存中的元数据同步到元数据中心</span>
            <span class="token function">doStoreProviderMetadata</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//内存中的元数据同步到本地文件</span>
            <span class="token function">saveProperties</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">!</span>syncReport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// retry again. If failed again, throw exception.</span>
            failedReports<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> serviceDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            metadataReportRetry<span class="token punctuation">.</span><span class="token function">startRetryTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to put provider metadata "</span> <span class="token operator">+</span> providerMetadataIdentifier <span class="token operator">+</span> <span class="token string">" in  "</span> <span class="token operator">+</span> serviceDefinition <span class="token operator">+</span> <span class="token string">", cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面代码我们主要看本地内存中的元数据同步到元数据中心和存本地的两个点:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//内存中的元数据同步到元数据中心</span>
<span class="token function">doStoreProviderMetadata</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//内存中的元数据同步到本地文件</span>
<span class="token function">saveProperties</span><span class="token punctuation">(</span>providerMetadataIdentifier<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>//内存中的元数据同步到元数据中心</p>
<p>这个方法会调用当前子类重写的具体存储逻辑:这里我们以<br>ZookeeperMetadataReport的doStoreProviderMetadata举例:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">storeMetadata</span><span class="token punctuation">(</span><span class="token class-name">MetadataIdentifier</span> metadataIdentifier<span class="token punctuation">,</span> <span class="token class-name">String</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//使用zkClient创建一个节点数据为参数V v是前面说的服务定义数据</span>
     zkClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getNodePath</span><span class="token punctuation">(</span>metadataIdentifier<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>这里参数我们举个例子: 提供者的元数据内容如下:<br>节点路径为:</p>
<ul>
<li>/dubbo/metadata/link.elastic.dubbo.entity.DemoService/provider/dubbo-demo-api-provider</li>
</ul>
<p>格式:</p>
<ul>
<li>/dubbo/metadata前缀</li>
<li>服务提供者接口</li>
<li>提供者类型provider</li>
<li>应用名</li>
</ul>
<p>具体的元数据内容如下:<br>比较详细的记录了应用信息,服务接口信息和服务接口对应的方法信息</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"side"</span><span class="token operator">:</span> <span class="token string">"provider"</span><span class="token punctuation">,</span>
    <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"link.elastic.dubbo.entity.DemoService"</span><span class="token punctuation">,</span>
    <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"38680"</span><span class="token punctuation">,</span>
    <span class="token property">"application"</span><span class="token operator">:</span> <span class="token string">"dubbo-demo-api-provider"</span><span class="token punctuation">,</span>
    <span class="token property">"dubbo"</span><span class="token operator">:</span> <span class="token string">"2.0.2"</span><span class="token punctuation">,</span>
    <span class="token property">"release"</span><span class="token operator">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>
    <span class="token property">"anyhost"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"bind.ip"</span><span class="token operator">:</span> <span class="token string">"192.168.1.9"</span><span class="token punctuation">,</span>
    <span class="token property">"methods"</span><span class="token operator">:</span> <span class="token string">"sayHello,sayHelloAsync"</span><span class="token punctuation">,</span>
    <span class="token property">"background"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"deprecated"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"dynamic"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"service-name-mapping"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"generic"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"bind.port"</span><span class="token operator">:</span> <span class="token string">"20880"</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"1653097653865"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"canonicalName"</span><span class="token operator">:</span> <span class="token string">"link.elastic.dubbo.entity.DemoService"</span><span class="token punctuation">,</span>
  <span class="token property">"codeSource"</span><span class="token operator">:</span> <span class="token string">"file:/Users/song/Desktop/Computer/A/code/gitee/weaving-a-net/weaving-test/dubbo-test/target/classes/"</span><span class="token punctuation">,</span>
  <span class="token property">"methods"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sayHello"</span><span class="token punctuation">,</span>
      <span class="token property">"parameterTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"java.lang.String"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"returnType"</span><span class="token operator">:</span> <span class="token string">"java.lang.String"</span><span class="token punctuation">,</span>
      <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sayHelloAsync"</span><span class="token punctuation">,</span>
      <span class="token property">"parameterTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"java.lang.String"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"returnType"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture"</span><span class="token punctuation">,</span>
      <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"types"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture"</span><span class="token punctuation">,</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"java.lang.Object"</span><span class="token punctuation">,</span>
        <span class="token property">"stack"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.lang.Object"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.lang.String"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span><span class="token punctuation">,</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"next"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span><span class="token punctuation">,</span>
        <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>本地缓存文件的写入 可以看下如下代码<br>AbstractMetadataReport类型的saveProperties方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveProperties</span><span class="token punctuation">(</span><span class="token class-name">MetadataIdentifier</span> metadataIdentifier<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> add<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>metadataIdentifier<span class="token punctuation">.</span><span class="token function">getUniqueKey</span><span class="token punctuation">(</span><span class="token class-name">KeyTypeEnum</span><span class="token punctuation">.</span>UNIQUE_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               properties<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>metadataIdentifier<span class="token punctuation">.</span><span class="token function">getUniqueKey</span><span class="token punctuation">(</span><span class="token class-name">KeyTypeEnum</span><span class="token punctuation">.</span>UNIQUE_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">long</span> version <span class="token operator">=</span> lastCacheChanged<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           	<span class="token comment">//获取最新修改版本持久化到磁盘</span>
               <span class="token keyword">new</span> <span class="token class-name">SaveProperties</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               reportCacheExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SaveProperties</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要看如下代码:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">SaveProperties</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SaveProperties类型代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SaveProperties</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">long</span> version<span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token class-name">SaveProperties</span><span class="token punctuation">(</span><span class="token keyword">long</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">=</span> version<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">doSaveProperties</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>继续看doSaveProperties方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doSaveProperties</span><span class="token punctuation">(</span><span class="token keyword">long</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//不是最新的就不要持久化了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">&lt;</span> lastCacheChanged<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Save</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
        	<span class="token comment">//创建本地文件锁:</span>
        	<span class="token comment">//路径为:</span>
        	<span class="token comment">///Users/song/.dubbo/dubbo-metadata-dubbo-demo-api-provider-127.0.0.1-2181.cache.lock</span>
            <span class="token class-name">File</span> lockfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//锁文件不存在则创建锁文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lockfile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lockfile<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//随机访问文件工具类对象创建 读写权限</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span> raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>lockfile<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//文件文件Channel</span>
            <span class="token comment">//返回与此文件关联的唯一FileChannel对象。</span>
                <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//FileChannel中的lock()与tryLock()方法都是尝试去获取在某一文件上的独有锁（以下简称独有锁），可以实现进程间操作的互斥。区别在于lock()会阻塞（blocking）方法的执行，tryLock()则不会。</span>
                <span class="token class-name">FileLock</span> lock <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果多个线程同时进来未获取锁的则抛出异常</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Can not lock the metadataReport cache file "</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", ignore and retry later, maybe multi java process use the file, please config: dubbo.metadata.file=xxx.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Save</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                	<span class="token comment">//文件不存在则创建本地元数据缓存文件</span>
                	<span class="token comment">///Users/song/.dubbo/dubbo-metadata-dubbo-demo-api-provider-127.0.0.1-2181.cache</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">Properties</span> tmpProperties<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>syncReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// When syncReport = false, properties.setProperty and properties.store are called from the same</span>
                        <span class="token comment">// thread(reportCacheExecutor), so deep copy is not required</span>
                        tmpProperties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Using store method and setProperty method of the this.properties will cause lock contention</span>
                        <span class="token comment">// under multi-threading, so deep copy a new container</span>
                        <span class="token comment">//异步存储会导致锁争用 使用此的store方法和setProperty方法。属性将导致多线程下的锁争用，因此深度复制新容器</span>
                        tmpProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            tmpProperties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileOutputStream</span> outputFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Properties类型自带的方法:</span>
                    <span class="token comment">//将此属性表中的属性列表（键和元素对）以适合使用load（Reader）方法的格式写入输出字符流。</span>
                        tmpProperties<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">,</span> <span class="token string">"Dubbo metadataReport Cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">&lt;</span> lastCacheChanged<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                reportCacheExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SaveProperties</span><span class="token punctuation">(</span>lastCacheChanged<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//这个代码太诡异了如果是lock失败也会打印异常给人非常疑惑的感觉 后续会修复</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Failed to save service store file, cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写入文件的内容大致如下</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">link.elastic.dubbo.entity.DemoService<span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span>provider<span class="token operator">:</span>dubbo-demo-api-provider -&gt; <span class="token punctuation">{</span>
  <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"side"</span><span class="token operator">:</span> <span class="token string">"provider"</span><span class="token punctuation">,</span>
    <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"link.elastic.dubbo.entity.DemoService"</span><span class="token punctuation">,</span>
    <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"41457"</span><span class="token punctuation">,</span>
    <span class="token property">"application"</span><span class="token operator">:</span> <span class="token string">"dubbo-demo-api-provider"</span><span class="token punctuation">,</span>
    <span class="token property">"dubbo"</span><span class="token operator">:</span> <span class="token string">"2.0.2"</span><span class="token punctuation">,</span>
    <span class="token property">"release"</span><span class="token operator">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>
    <span class="token property">"anyhost"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"bind.ip"</span><span class="token operator">:</span> <span class="token string">"192.168.1.9"</span><span class="token punctuation">,</span>
    <span class="token property">"methods"</span><span class="token operator">:</span> <span class="token string">"sayHello,sayHelloAsync"</span><span class="token punctuation">,</span>
    <span class="token property">"background"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"deprecated"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"dynamic"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"service-name-mapping"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"generic"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
    <span class="token property">"bind.port"</span><span class="token operator">:</span> <span class="token string">"20880"</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"1653100253548"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"canonicalName"</span><span class="token operator">:</span> <span class="token string">"link.elastic.dubbo.entity.DemoService"</span><span class="token punctuation">,</span>
  <span class="token property">"codeSource"</span><span class="token operator">:</span> <span class="token string">"file:/Users/song/Desktop/Computer/A/code/gitee/weaving-a-net/weaving-test/dubbo-test/target/classes/"</span><span class="token punctuation">,</span>
  <span class="token property">"methods"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sayHelloAsync"</span><span class="token punctuation">,</span>
      <span class="token property">"parameterTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"java.lang.String"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"returnType"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture"</span><span class="token punctuation">,</span>
      <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sayHello"</span><span class="token punctuation">,</span>
      <span class="token property">"parameterTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"java.lang.String"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"returnType"</span><span class="token operator">:</span> <span class="token string">"java.lang.String"</span><span class="token punctuation">,</span>
      <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"types"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture"</span><span class="token punctuation">,</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"java.lang.Object"</span><span class="token punctuation">,</span>
        <span class="token property">"stack"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.lang.Object"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.lang.String"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span><span class="token punctuation">,</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"next"</span><span class="token operator">:</span> <span class="token string">"java.util.concurrent.CompletableFuture.Completion"</span><span class="token punctuation">,</span>
        <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看原文,技术<strong>咨询</strong>与<strong>支持</strong>,可以扫描<strong>微信公众号</strong>进行回复咨询<br><img src="https://img-blog.csdnimg.cn/20210523134648783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbmdqdW55YW4=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>

			<br>
			
			
			<a class="tag-unordered list-link" href="/tags/Dubbo/" rel="tag">Dubbo<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3/" rel="tag">Dubbo3<span class="tag-unordered list-count">23</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">Dubbo3源码解析<span class="tag-unordered list-count">23</span></a>

			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
        
    

    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                         <!-- 下一篇文章 --> 
                            <div class="new">
                                <span>下一章</span>
                                <a href="/2022/07/10/dubbo/16-mo-kuai-fa-bu-qi-fa-bu-fu-wu-quan-guo-cheng/"> 16-【Dubbo3.0.8源码解析系列】模块发布器发布服务全过程</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2022/07/10/dubbo/14-dubbo-pei-zhi-jia-zai-quan-jie-xi/"> 14-【Dubbo3.0.8源码解析系列】Dubbo配置加载全解析</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'OrwF9gExPcH3pyeb35WIuKun-9Nh9j0Va',
        appKey: 'W098QAVm3hxbnBWRpho3a6HN'
    })
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">中间件源码</div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                </div>
                <div calss="footer-copyright">&copy; 2022 中间件源码
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
