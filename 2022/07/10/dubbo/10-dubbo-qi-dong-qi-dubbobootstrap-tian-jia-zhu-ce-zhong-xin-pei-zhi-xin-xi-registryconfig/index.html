<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		
<title>10-【Dubbo3.0.8源码解析系列】Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig - 中间件源码</title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 6.2.0">
<link rel="stylesheet" href="/css/style.css?v=1666315348317">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1666315348317"></script>






    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?2ee30baeebf59e698360da94012edd15';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="中间件源码" type="application/atom+xml">
</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="中间件源码">中间件源码</a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/index.html">首页</a></li>
            
                <li class="nav-item"><a href="/categories">分类</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>10-【Dubbo3.0.8源码解析系列】Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig</h1>
			<div class="info"><span class="date">2022年7月10日</span>•songxiaosheng 
			
					《<a class="nexmoefont icon-appstore-fill -link" href="/categories/Dubbo3%E6%BA%90%E7%A0%81/">Dubbo3源码</a>》
				
				<!-- 
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/dubbo/10-Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig.md" target="_blank" rel="external nofollow noreferrer noopener">编辑</a>
				 -->
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="10-Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig"><a href="#10-Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig" class="headerlink" title="10-Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig"></a>10-Dubbo启动器DubboBootstrap添加注册中心配置信息RegistryConfig</h1><h2 id="10-1-简介"><a href="#10-1-简介" class="headerlink" title="10.1 简介"></a>10.1 简介</h2><p>先贴个代码用来参考:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DubboBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token class-name">DubboBootstrap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bootstrap<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">"dubbo-demo-api-provider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">"zookeeper://127.0.0.1:2181"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolConfig</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>DUBBO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上个博客我们说了启动器ApplicationConfig对象的创建,启动器对象在启动之前是要初始化一些配置信息的,这里我们来看这一行代码注册中心配置信息:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">registry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">"zookeeper://127.0.0.1:2181"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h2 id="10-2-注册中心的配置相关"><a href="#10-2-注册中心的配置相关" class="headerlink" title="10.2  注册中心的配置相关"></a>10.2  注册中心的配置相关</h2><p>下面的配置来源于官网</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>对应URL参数</th>
<th>类型</th>
<th>是否必填</th>
<th>缺省值</th>
<th>作用</th>
<th>描述</th>
<th>兼容性</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td></td>
<td>string</td>
<td>可选</td>
<td></td>
<td>配置关联</td>
<td>注册中心引用BeanId，可以在&lt;dubbo:service registry=””&gt;或&lt;dubbo:reference registry=””&gt;中引用此ID</td>
<td>1.0.16以上版本</td>
</tr>
<tr>
<td>address</td>
<td><a href="host:port">host:port</a></td>
<td>string</td>
<td><strong>必填</strong></td>
<td></td>
<td>服务发现</td>
<td>注册中心服务器地址，如果地址没有端口缺省为9090，同一集群内的多个地址用逗号分隔，如：ip:port,ip:port，不同集群的注册中心，请配置多个<a href="dubbo:registry">dubbo:registry</a>标签</td>
<td>1.0.16以上版本</td>
</tr>
<tr>
<td>protocol</td>
<td><protocol></protocol></td>
<td>string</td>
<td>可选</td>
<td>dubbo</td>
<td>服务发现</td>
<td>注册中心地址协议，支持<code>dubbo</code>, <code>multicast</code>, <code>zookeeper</code>, <code>redis</code>, <code>consul(2.7.1)</code>, <code>sofa(2.7.2)</code>, <code>etcd(2.7.2)</code>, <code>nacos(2.7.2)</code>等协议</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>port</td>
<td><port></port></td>
<td>int</td>
<td>可选</td>
<td>9090</td>
<td>服务发现</td>
<td>注册中心缺省端口，当address没有带端口时使用此端口做为缺省值</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>username</td>
<td><username></username></td>
<td>string</td>
<td>可选</td>
<td></td>
<td>服务治理</td>
<td>登录注册中心用户名，如果注册中心不需要验证可不填</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>password</td>
<td><password></password></td>
<td>string</td>
<td>可选</td>
<td></td>
<td>服务治理</td>
<td>登录注册中心密码，如果注册中心不需要验证可不填</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>transport</td>
<td>registry.transporter</td>
<td>string</td>
<td>可选</td>
<td>netty</td>
<td>性能调优</td>
<td>网络传输方式，可选mina,netty</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>timeout</td>
<td>registry.timeout</td>
<td>int</td>
<td>可选</td>
<td>5000</td>
<td>性能调优</td>
<td>注册中心请求超时时间(毫秒)</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>session</td>
<td>registry.session</td>
<td>int</td>
<td>可选</td>
<td>60000</td>
<td>性能调优</td>
<td>注册中心会话超时时间(毫秒)，用于检测提供者非正常断线后的脏数据，比如用心跳检测的实现，此时间就是心跳间隔，不同注册中心实现不一样。</td>
<td>2.1.0以上版本</td>
</tr>
<tr>
<td>file</td>
<td>registry.file</td>
<td>string</td>
<td>可选</td>
<td></td>
<td>服务治理</td>
<td>使用文件缓存注册中心地址列表及服务提供者列表，应用重启时将基于此文件恢复，注意：两个注册中心不能使用同一文件存储</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>wait</td>
<td>registry.wait</td>
<td>int</td>
<td>可选</td>
<td>0</td>
<td>性能调优</td>
<td>停止时等待通知完成时间(毫秒)</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>check</td>
<td>check</td>
<td>boolean</td>
<td>可选</td>
<td>true</td>
<td>服务治理</td>
<td>注册中心不存在时，是否报错</td>
<td>2.0.0以上版本</td>
</tr>
<tr>
<td>register</td>
<td>register</td>
<td>boolean</td>
<td>可选</td>
<td>true</td>
<td>服务治理</td>
<td>是否向此注册中心注册服务，如果设为false，将只订阅，不注册</td>
<td>2.0.5以上版本</td>
</tr>
<tr>
<td>subscribe</td>
<td>subscribe</td>
<td>boolean</td>
<td>可选</td>
<td>true</td>
<td>服务治理</td>
<td>是否向此注册中心订阅服务，如果设为false，将只注册，不订阅</td>
<td>2.0.5以上版本</td>
</tr>
<tr>
<td>dynamic</td>
<td>dynamic</td>
<td>boolean</td>
<td>可选</td>
<td>true</td>
<td>服务治理</td>
<td>服务是否动态注册，如果设为false，注册后将显示为disable状态，需人工启用，并且服务提供者停止时，也不会自动取消注册，需人工禁用。</td>
<td>2.0.5以上版本</td>
</tr>
<tr>
<td>group</td>
<td>group</td>
<td>string</td>
<td>可选</td>
<td>dubbo</td>
<td>服务治理</td>
<td>服务注册分组，跨组的服务不会相互影响，也无法相互调用，适用于环境隔离。</td>
<td>2.0.5以上版本</td>
</tr>
<tr>
<td>simplified</td>
<td>simplified</td>
<td>boolean</td>
<td>可选</td>
<td>false</td>
<td>服务治理</td>
<td>注册到注册中心的URL是否采用精简模式的（与低版本兼容）</td>
<td>2.7.0以上版本</td>
</tr>
<tr>
<td>extra-keys</td>
<td>extraKeys</td>
<td>string</td>
<td>可选</td>
<td></td>
<td>服务治理</td>
<td>在simplified=true时，extraKeys允许你在默认参数外将额外的key放到URL中，格式：“interface,key1,key2”。</td>
<td>2.7.0以上版本</td>
</tr>
</tbody></table>
<p> 同样官网提供的参数里面并未包含所有的属性 下面我就将其余的属性列举一下方便学习参考:</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>server</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>client</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>cluster</td>
<td>String</td>
<td>影响流量在注册中心之间的分布，在订阅多个注册中心时很有用，可用选项：1。区域感知，特定类型的流量总是根据流量的来源进入一个注册表。</td>
</tr>
<tr>
<td>zone</td>
<td>String</td>
<td>注册表所属的区域，通常用于隔离流量</td>
</tr>
<tr>
<td>parameters</td>
<td>Map&lt;String, String&gt;</td>
<td>自定义参数</td>
</tr>
<tr>
<td>useAsConfigCenter</td>
<td>Boolean</td>
<td>该地址是否用作配置中心</td>
</tr>
<tr>
<td>useAsMetadataCenter</td>
<td>Boolean</td>
<td>该地址是否用作远程元数据中心</td>
</tr>
<tr>
<td>accepts</td>
<td>String</td>
<td>此注册表接受的rpc协议列表，例如“dubbo，rest”</td>
</tr>
<tr>
<td>preferred</td>
<td>Boolean</td>
<td>如果设置为true，则始终首先使用此注册表，这在订阅多个注册表时非常有用</td>
</tr>
<tr>
<td>weight</td>
<td>Integer</td>
<td>影响注册中心之间的流量分布，当订阅多个注册中心仅在未指定首选注册中心时才生效时，此功能非常有用。</td>
</tr>
<tr>
<td>registerMode</td>
<td>String</td>
<td>注册模式:实例级,接口级,所有</td>
</tr>
<tr>
<td>enableEmptyProtection</td>
<td>Boolean</td>
<td>收到的空url地址列表和空保护被禁用，将清除当前可用地址</td>
</tr>
</tbody></table>
<h2 id="10-3-注册中心配置对象创建与添加"><a href="#10-3-注册中心配置对象创建与添加" class="headerlink" title="10.3 注册中心配置对象创建与添加"></a>10.3 注册中心配置对象创建与添加</h2><p>前面例子中调用的代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">"zookeeper://127.0.0.1:2181"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先我们要来看的是RegistryConfig类型的构造器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>继续看setAddress方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//保存地址</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
       <span class="token comment">//下面是支持将参数在url地址后面 比如用户名,密码,协议,端口,这几个参数提前做解析放入成员变量中</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>address <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">try</span> <span class="token punctuation">{</span>
           	<span class="token comment">//地址转Dubbo的URL对象 这个URL是Dubbo自行实现的URL封装信息的类型</span>
               <span class="token class-name">URL</span> url <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token comment">// Refactor since 2.7.8</span>
               <span class="token comment">//值不存在时候更新属性,非常巧妙的代码 重构了多个if判断</span>
               <span class="token comment">//第一个参数值不存在则调用第二个方法,第二个方法的参数为第三方方法			 </span>
               <span class="token function">updatePropertyIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">setUsername</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">updatePropertyIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getPassword</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">setPassword</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">updatePropertyIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getProtocol</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">setProtocol</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">updatePropertyIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getPort</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">setPort</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//移除掉url中的backup自定义参数 (备份的注册中心地址)</span>
               <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmptyMap</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   params<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>BACKUP_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token comment">//将自定义参数存储到成员变量中</span>
               <span class="token function">updateParameters</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>然后再回过头来看DubboBootstrap的registry方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DubboBootstrap</span> <span class="token function">registry</span><span class="token punctuation">(</span><span class="token class-name">RegistryConfig</span> registryConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将applicationModel对象设置给注册中心配置对象</span>
      registryConfig<span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span>applicationModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//将注册中心配置对象添加到配置管理器中</span>
      configManager<span class="token punctuation">.</span><span class="token function">addRegistry</span><span class="token punctuation">(</span>registryConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>直接来看配置管理器configManager的添加注册中心配置addRegistry方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRegistry</span><span class="token punctuation">(</span><span class="token class-name">RegistryConfig</span> registryConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addConfig</span><span class="token punctuation">(</span>registryConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>configManager 的addConfig方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConfig</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">addConfig</span><span class="token punctuation">(</span><span class="token class-name">AbstractConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ignore MethodConfig</span>
        <span class="token comment">//检查当前配置管理器支持管理的配置对象</span>
        <span class="token comment">//目前支持的配置有ApplicationConfig,MonitorConfig,MetricsConfig,SslConfig,</span>
        <span class="token comment">//ProtocolConfig,RegistryConfig,ConfigCenterConfig,MetadataReportConfig   </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSupportConfigType</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unsupported config type: "</span> <span class="token operator">+</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getScopeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> scopeModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config<span class="token punctuation">.</span><span class="token function">setScopeModel</span><span class="token punctuation">(</span>scopeModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//缓存中是否存在</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractConfig</span><span class="token punctuation">&gt;</span></span> configsMap <span class="token operator">=</span> configsCache<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span><span class="token function">getTagName</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//不是服务级接口配置则直接从缓存中读取到配置之后直接返回</span>
        <span class="token comment">// fast check duplicated equivalent config before write lock</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>config <span class="token keyword">instanceof</span> <span class="token class-name">ReferenceConfigBase</span> <span class="token operator">||</span> config <span class="token keyword">instanceof</span> <span class="token class-name">ServiceConfigBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractConfig</span> value <span class="token operator">:</span> configsMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// lock by config type</span>
        <span class="token comment">//添加配置</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>configsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">addIfAbsent</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> configsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>ConfigManager配置管理器的addIfAbsent方法:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConfig</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">C</span> <span class="token function">addIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">C</span> config<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> configsMap<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
		<span class="token comment">//配置信息为空直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> configsMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> config<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// find by value</span>
        <span class="token comment">//根据配置规则判断,配置存在则返回</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> prevConfig <span class="token operator">=</span> <span class="token function">findDuplicatedConfig</span><span class="token punctuation">(</span>configsMap<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevConfig<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> prevConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">//生成配置key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment">// generate key if id is not set</span>
                key <span class="token operator">=</span> <span class="token function">generateConfigId</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>configsMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//不相同的配置key重复则抛出异常</span>
        <span class="token class-name">C</span> existedConfig <span class="token operator">=</span> configsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existedConfig <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEquals</span><span class="token punctuation">(</span>existedConfig<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> type <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Duplicate %s found, there already has one default %s or more than two %ss have the same id, "</span> <span class="token operator">+</span>
                    <span class="token string">"you can try to give each %s a different id, override previous config with later config. id: %s, prev: %s, later: %s"</span><span class="token punctuation">,</span>
                type<span class="token punctuation">,</span> type<span class="token punctuation">,</span> type<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> existedConfig<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// override existed config if any</span>
        <span class="token comment">//将配置对象存入configsMap对象中,configsMap来源于configsCache</span>
        configsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<p> 技术<strong>咨询</strong>与<strong>支持</strong>,可以扫描<strong>微信公众号</strong>进行回复咨询<br><img src="https://img-blog.csdnimg.cn/20210523134648783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbmdqdW55YW4=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>

			<br>
			
			
			<a class="tag-unordered list-link" href="/tags/Dubbo/" rel="tag">Dubbo<span class="tag-unordered list-count">26</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3/" rel="tag">Dubbo3<span class="tag-unordered list-count">26</span></a>, <a class="tag-unordered list-link" href="/tags/Dubbo3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">Dubbo3源码解析<span class="tag-unordered list-count">26</span></a>

			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
        
    

    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                         <!-- 下一篇文章 --> 
                            <div class="new">
                                <span>下一章</span>
                                <a href="/2022/07/10/dubbo/11-dubbo-qi-dong-qi-dubbobootstrap-tian-jia-xie-yi-pei-zhi-xin-xi-protocolconfig/"> 11-【Dubbo3.0.8源码解析系列】Dubbo启动器DubboBootstrap添加协议配置信息ProtocolConfig</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2022/07/10/dubbo/9-dubbo-qi-dong-qi-dubbobootstrap-tian-jia-ying-yong-cheng-xu-de-pei-zhi-xin-xi-applicationconfig/"> 09-【Dubbo3.0.8源码解析系列】Dubbo启动器DubboBootstrap添加应用程序的配置信息ApplicationConfig</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'OrwF9gExPcH3pyeb35WIuKun-9Nh9j0Va',
        appKey: 'W098QAVm3hxbnBWRpho3a6HN'
    })
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">中间件源码</div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                </div>
                <div calss="footer-copyright">&copy; 2022 中间件源码
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
